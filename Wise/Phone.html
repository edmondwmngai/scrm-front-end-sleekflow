<!DOCTYPE html>
<html lang="en">
<head>
	<title></title>
	<!--
	<meta http-equiv="X-UA-Compatible" content="IE=8">
	-->
	<meta http-equiv="pragma" content="no-cache">
	<meta http-equiv="expires" content="0">
	<meta http-equiv="cache-control" content="max-age=0" />
	<meta http-equiv="cache-control" content="no-cache, no-store, must-revalidate" />
	<meta http-equiv="expires" content="0" />
	<meta http-equiv="expires" content="mon, 22 jul 2002 11:12:01 gmt" />
	<meta http-equiv="pragma" content="no-cache" />

	<style type="text/css">

		.container {
			width: auto;
			display: inline-block;
			overflow-x: auto;
			overflow-y: hidden;
			margin: 0px;
		}

			.container::-webkit-scrollbar {
				width: 6px;
				height: 6px;
			}

			.container::-webkit-scrollbar-thumb {
				-webkit-border-radius: 8px;
				border-radius: 8px;
				background: #AECBFC;
			}

			.container::-webkit-scrollbar-track {
				background: lightgray
			}

		.num-btn {
			vertical-align: middle;
			-webkit-border-radius: 8;
			-moz-border-radius: 8;
			border-radius: 8px;
			font-family: Roboto,sans-serif;
			color: #000000;
			font-size: 14px;
			background: #ffffff;
			padding: 8px 12px 8px 12px;
			border: solid #1f628d 2px;
			text-decoration: none;
			cursor: pointer;
		}

		.num-btn2 {
			vertical-align: middle;
			-webkit-border-radius: 8;
			-moz-border-radius: 8;
			border-radius: 4px;
			font-family: Roboto,sans-serif;
			color: #000000;
			font-size: 10px;
			background: #ffffff;
			padding: 6px 8px 6px 8px;
			border: solid #1f628d 2px;
			text-decoration: none;
			cursor: pointer;
		}

		.num-btn:hover {
			background: #3cb0fd;
			text-decoration: none;
		}

		.call-btn {
			-webkit-border-radius: 5;
			-moz-border-radius: 5;
			border-radius: 5px;
			font-family: Roboto,sans-serif;
			color: #000000;
			font-size: 10px;
			background: #E3F6CE;
			padding: 5px 10px 5px 10px;
			border: solid #1f628d 2px;
			text-decoration: none;
			cursor: pointer;
		}

		.img-btn {
			vertical-align: middle;
		}

		.status-box {
			vertical-align: middle;
			-webkit-border-radius: 8;
			-moz-border-radius: 8;
			border-radius: 8px;
			font-family: Roboto,sans-serif;
			color: #000000;
			font-size: 14px;
			background: #A9E2F3;
			padding: 5px 10px 5px 10px;
			border: solid #1f628d 2px;
			text-decoration: none;
			display: inline-block;
			right: 0px;
		}

		.css_table {
			display: table;
		}

		.css_tr {
			display: table-row;
			width: 100%;
		}

		.css_td {
			display: inline-block;
			font-size: 14px;
			height: 100%;
			-webkit-border-radius: 8;
			-moz-border-radius: 8;
			border-radius: 8px;
		}

			.css_td.rowspanned {
				position: absolute;
				top: 0;
				bottom: 0;
				width: 100px;
			}

		.queue_content {
			display: inline-block;
			margin: 5px 5px 0px 0px;
			box-shadow: 0 2px 4px 0 rgba(0,0,0,.14);
			border-radius: 3px;
			transition: .3s;
			background: #ffff;
			width: 130px;
			height: 80px;
		}

		.queue_subcontent1 {
			display: inline-block;
			margin-top: -10px;
			margin-left: 10px;
			position: absolute;
			width: 30%;
		}

		.queue_title {
			display: inline-block;
			position: relative;
			text-align: right;
			margin: 2px 0 0 -5px;
			width: 100%
		}

		.queue_subcontent2 {
			display: inline-block;
			position: relative;
			width: 100%;
			font-size: 18px;
			margin-top: 10px;
			text-align: center;
		}
	</style>
	<script src="../config.js"></script>
	<!--<script src="script/jquery-1.12.4.min.js"></script>-->
	<!--<script type="text/javascript" src="../js/jquery.min.js"></script>-->
	<!--<script src="https://code.jquery.com/jquery-3.7.1.slim.min.js" integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8=" crossorigin="anonymous"></script>-->
	<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

	<script src="script/jquery.formatDateTime.js"></script>
	<script src="script/wsLibrary.js"></script>
	<script src="script/wsMonitor.js"></script>
	<script src="script/wsSHandler.js?v=123"></script>
	<!--<script src="script/shadler/main.js"></script>-->
	<script src="script/shandler/socialMediaSL.js"></script>
	<script src="script/shandler/SocialContentSL.js"></script>
	<!--<script src="../js/moment.js"></script>-->
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment.min.js" integrity="sha512-QoJS4DOhdmG8kbbHkxmB/rtPdN62cGWXAdAFWWJPvUFF1/zxcPSdAnn4HhYZSIlVoLVEJ0LesfNlusgm2bPfnA==" crossorigin="anonymous"></script>
	<script src='script/shandler/handlebars.min.js'></script>
	<script src="script/shandler/waTemplateService.js"></script>
	<script src="script/shandler/casehistscripts.js"></script>

	<script src="script/constant.js"></script>
	<script src="script/runtime.js"></script>
	<script src="script/promise-polyfill.min.js"></script>
	<script type="text/javascript">



		if (!Array.prototype.findIndex) {
			Object.defineProperty(Array.prototype, 'findIndex', {
				value: function (predicate) {
					// 1. Let O be ? ToObject(this value).
					if (this == null) {
						throw new TypeError('"this" is null or not defined');
					}

					var o = Object(this);

					// 2. Let len be ? ToLength(? Get(O, "length")).
					var len = o.length >>> 0;

					// 3. If IsCallable(predicate) is false, throw a TypeError exception.
					if (typeof predicate !== 'function') {
						throw new TypeError('predicate must be a function');
					}

					// 4. If thisArg was supplied, let T be thisArg; else let T be undefined.
					var thisArg = arguments[1];

					// 5. Let k be 0.
					var k = 0;

					// 6. Repeat, while k < len
					while (k < len) {
						// a. Let Pk be ! ToString(k).
						// b. Let kValue be ? Get(O, Pk).
						// c. Let testResult be ToBoolean(? Call(predicate, T, « kValue, k, O »)).
						// d. If testResult is true, return k.
						var kValue = o[k];
						if (predicate.call(thisArg, kValue, k, o)) {
							return k;
						}
						// e. Increase k by 1.
						k++;
					}

					// 7. Return -1.
					return -1;
				}
			});
		}
	</script>

	<script type="text/javascript">

		function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { return Promise.resolve(value).then(function (value) { step("next", value); }, function (err) { step("throw", err); }); } } return step("next"); }); }; }

		var loginId = sessionStorage.getItem('scrmAgentId');

		var gettingOnlineTicket = {};
		var statusStyle = config.statusStyle || { "LOGIN": "#6c757d", "IDLE": "#FF2735", "TALK": "#4caf50", "HOLD": "rgb(201, 203, 207)", "READY": "rgb(54 102 189)", "#dbdb30": "rgba(21, 193, 231, 0.9)", "BREAK": "#AB4A0E", "MONITOR": "rgb(153, 102, 255)" };
		var serviceList = [];
		var noRingStatuses = config.noRingStatuses || [];
		var customCompany = sessionStorage.getItem('scrmCustomCompany');
		// document.write is going to be deprecated, need to write script like below
		if (customCompany && customCompany != 'no') {
			var scriptElement = document.createElement('script');
			scriptElement.type = 'text/javascript';
			scriptElement.src = "script/sl-" + customCompany + ".js";
			// insert the script tag
			var headTag = document.getElementsByTagName('head')[0];
			headTag.insertBefore(scriptElement, headTag.firstChild);
		} else {
			var scriptElement = document.createElement('script');
			scriptElement.type = 'text/javascript';
			scriptElement.src = "script/sl-no.js";
			// insert the script tag
			var headTag = document.getElementsByTagName('head')[0];
			headTag.insertBefore(scriptElement, headTag.firstChild);
		}
		/*
		serviceList.push({
			name : "HKDNR_E",
			caption : "HKDNR {E}",
			callType: CATY_INDB,
			dnis: "5010",
			acdGroup: 1,
			showPriority : 1
		});

		serviceList.push({
			name : "KingParrot",
			caption : "King Parrot (A)",
			callType: CATY_EMAIL,
			acdGroup: 1,
			dnis: "eprotel27990202@gmail.com",
			showPriority : 2
		});

		serviceList.push({
			name : "OCF",
			caption : "One Call Fix",
			callType: CATY_INDB,
			dnis: "5009",
			acdGroup: 1,
			showPriority : 1
		});
		serviceList.push({
			name : "OCF",
			caption : "One Call Fix",
			callType: CATY_VMAIL,
			dnis: "5009",
			acdGroup: 1,
			showPriority : 2
		});

		serviceList.push({
			name : "OCF",
			caption : "One Call Fix",
			callType: CATY_FAX,
			dnis: "5998",
			acdGroup: 1,
			showPriority : 2
		});

		*/

		// serviceList.push({
		// 	name : "HKTB",
		// 	shortName: "TB",
		// 	caption : "",
		// 	callType: CATY_WEBCHAT,
		// 	dnis: "SM_Win2016-demoWebChat",
		// 	acdGroup: 1,
		// 	showPriority : 1
		// });


		// serviceList.push({
		// 	name : "HKTB",
		// 	shortName: "TB",
		// 	caption : "",
		// 	callType: CATY_INDB,
		// 	dnis: "9000",
		// 	acdGroup: 1,
		// 	showPriority : 1
		// });

		// serviceList.push({
		// 	name : "HKTB",
		// 	shortName: "TB",
		// 	caption : "",
		// 	callType: CATY_INDB,
		// 	dnis: "9000",
		// 	acdGroup: 2,
		// 	showPriority : 1
		// });

		// serviceList.push({
		// 	name : "HKTB",
		// 	shortName: "TB",
		// 	caption : "",
		// 	callType: CATY_INDB,
		// 	dnis: "9000",
		// 	acdGroup: 3,
		// 	showPriority : 1
		// });



		// serviceList.push({
		// 	name : "HKTB",
		// 	shortName: "TB",
		// 	caption : "",
		// 	callType: CATY_VMAIL,
		// 	dnis: "9001",
		// 	acdGroup: 1,
		// 	showPriority : 2
		// });

		// serviceList.push({
		// 	name : "HKTB",
		// 	shortName: "TB",
		// 	caption : "",
		// 	callType: CATY_FAX,
		// 	dnis: "5702",
		// 	acdGroup: 5,
		// 	showPriority : 2
		// });

		// serviceList.push({
		// 	name : "HKTB",
		// 	shortName: "TB",
		// 	caption : "",
		// 	callType: CATY_EMAIL,
		// 	dnis: "demo-cpb@eprotel.com.hk",
		// 	acdGroup: 1,
		// 	showPriority : 2
		// });

		// serviceList.push({
		// 	name : "HKTB",
		// 	shortName: "TB",
		// 	caption : "",
		// 	callType: CATY_BLOG,
		// 	dnis: "SM_Win2016-demoWeChat",
		// 	acdGroup: 1,
		// 	showPriority : 1
		// });

		// serviceList.push({
		// 	name : "HKTB",
		// 	shortName: "TB",
		// 	caption : "",
		// 	callType: CATY_BLOG,
		// 	dnis: "SM_Win2016-demoFB",
		// 	acdGroup: 1,
		// 	showPriority : 1
		// });
		/*
		serviceList.push({
			name : "NP360",
			shortName: "360",
			caption : "NP360",
			callType: CATY_BLOG,
			dnis: "SM_EproWechat154",
			acdGroup: 5,
			showPriority : 1
		});
		*/
		/*
		serviceList.push({
			name : "OneCallFix",
			shortName: "OCF",
			caption : "OCF",
			callType: CATY_BLOG,
			dnis: "SM_EproOCF",
			acdGroup: 6,
			showPriority : 1
		});

		serviceList.push({
			name : "OneCallFix",
			shortName: "OCF",
			caption : "OCF",
			callType: CATY_BLOG,
			dnis: "SM_SCRM2WeChat154",
			acdGroup: 6,
			showPriority : 1
		});

		serviceList.push({
			name : "OneCallFix",
			shortName: "OCF",
			caption : "OCF",
			callType: CATY_WEBCHAT,
			dnis: "SM_SCRM2WebChat154",
			acdGroup: 6,
			showPriority : 1
		});

		serviceList.push({
			name : "OneCallFix",
			shortName: "OCF",
			caption : "OCF",
			callType: CATY_INDB,
			dnis: "5710",
			acdGroup: 6,
			showPriority : 1
		});

		serviceList.push({
			name : "OneCallFix",
			shortName: "OCF",
			caption : "OCF",
			callType: CATY_VMAIL,
			dnis: "5711",
			acdGroup: 6,
			showPriority : 2
		});

		serviceList.push({
			name : "OneCallFix",
			shortName: "OCF",
			caption : "OCF",
			callType: CATY_FAX,
			dnis: "5712",
			acdGroup: 6,
			showPriority : 2
		});

		serviceList.push({
			name : "OneCallFix",
			shortName: "OCF",
			caption : "OCF",
			callType: CATY_EMAIL,
			dnis: "scrm2@eprotel.com.hk",
			acdGroup: 6,
			showPriority : 2
		});
		*/
		// var outboundANI ={};
		// outboundANI["HKTB"] ={call: "36202316", fax: "5702", faxCover: "D:\\FaxShare\\cover.cov", email: "demo-cpb@eprotel.com.hk", sms: "2003"};
		//outboundANI["OneCallFix"] ={call: "5710", fax: "5712", faxCover: "D:\\FaxShare\\cover.cov", email: "scrm2@eprotel.com.hk", sms: "5703$ONE"};

		var queueLayout = {};
		/*
		queueLayout[CATY_INDB]={ prefix: "inbound", style: "vertical-align:top; height:86px; width:70px;border: solid #B40404 2px;color:#B40404", image: "img/call-icon-512.png", color: "#B40404" };
		queueLayout[CATY_EMAIL]={ prefix: "email", style: "vertical-align:top; height:86px; width:70px;border: solid #298A08 2px;color:#298A08", image: "img/email-icon-512.png", color: "#298A08"};
		queueLayout[CATY_VMAIL]={ prefix: "vmail", style: "vertical-align:top; height:86px; width:70px;border: solid #DF7401 2px;color:#DF7401", image: "img/vmail-icon-256.png", color: "#DF7401"};
		queueLayout[CATY_FAX]={ prefix: "fax", style: "vertical-align:top; height:86px; width:70px;border: solid #515151 2px;color:#515151", image: "img/fax-icon-256.png", color: "#515151"};
		queueLayout[CATY_WEBCHAT]={ prefix: "webchat", style: "vertical-align:top; height:86px; width:70px;border: solid #086A87 2px;color:#086A87", image: "img/webchat-icon-217.png", color: "#086A87"};
		queueLayout[CATY_BLOG]={ prefix: "blog", style: "vertical-align:top; height:86px; width:70px;border: solid #475993 2px;color:#475993", image: "img/sm-icon-200.png",color: "#475993"};
		*/
		queueLayout[CATY_INDB] = { prefix: "inbound", style: "width:48px;border-radius:3px;background: linear-gradient(60deg,#EF7C50,#e53935);box-shadow:3px 3px 4px 0 rgba(0,0,0,.36);", image: "img/call-icon-512-2.png", color: "#E9433F" };
		queueLayout[CATY_EMAIL] = { prefix: "email", style: "width:48px;border-radius:3px;background: linear-gradient(60deg,#FFC83D,#fb8c00);box-shadow:3px 3px 4px 0 rgba(0,0,0,.36);", image: "img/email-icon-512-2.png", color: "#F89A1E" };
		queueLayout[CATY_VMAIL] = { prefix: "vmail", style: "width:48px;border-radius:3px;background: linear-gradient(60deg,#86B784,#43a047);box-shadow:3px 3px 4px 0 rgba(0,0,0,.36);", image: "img/vmail-icon-512-2.png", color: "#52BD00" };
		queueLayout[CATY_FAX] = { prefix: "fax", style: "width:48px;border-radius:3px;background:linear-gradient(60deg,#6AD1D8,#00acc1);box-shadow:3px 3px 4px 0 rgba(0,0,0,.36);", image: "img/fax-icon-512-2.png", color: "#08B1C6" };
		queueLayout[CATY_WEBCHAT] = { prefix: "webchat", style: "width:48px;border-radius:3px;background:linear-gradient(60deg,#F48FB1,#F06292);box-shadow:3px 3px 4px 0 rgba(0,0,0,.36);", image: "img/webchat-icon-512-2.png", color: "#F06292" };
		queueLayout[CATY_BLOG] = { prefix: "blog", style: "width:48px;border-radius:3px;background:linear-gradient(60deg,#7986CB,#3D5A98);box-shadow:3px 3px 4px 0 rgba(0,0,0,.36);", image: "img/fb-icon-512-2.png", color: "#3D5A98" };
		// wechat
		queueLayout[CATY_WECHAT] = { prefix: "wechat", style: "width:48px;border-radius:3px;background: linear-gradient(60deg,#86B784,#3CB034);box-shadow:3px 3px 4px 0 rgba(0,0,0,.36);", image: "img/wechat-icon-512.png", color: "#3CB034" };
		queueLayout[CATY_WHATSAPP] = { prefix: "whatsapp", style: "width:48px;border-radius:3px;background: linear-gradient(60deg,#86B784,#3CB034);box-shadow:3px 3px 4px 0 rgba(0,0,0,.36);", image: "img/whatsapp-icon-512.png", color: "#3CB034" };
		queueLayout[CATY_FBMSG] = { prefix: "fbmsg", style: "width:48px;border-radius:3px;background: linear-gradient(60deg,#6977BC,#437BBD);box-shadow:3px 3px 4px 0 rgba(0,0,0,.36);", image: "img/fbmsg-icon-512.png", color: "#6977BC" };
		queueLayout[CATY_FBPOST] = { prefix: "fbpost", style: "width:48px;border-radius:3px;background: linear-gradient(60deg,#7986CB,#3D5A98);box-shadow:3px 3px 4px 0 rgba(0,0,0,.36);", image: "img/fbpost-icon-512.png", color: "#7986CB" };

		var channels = {};
		channels[CATY_INDB] = "Inbound_Call";
		channels[CATY_EMAIL] = "Inbound_Email";
		channels[CATY_VMAIL] = "Inbound_Voicemail";
		channels[CATY_FAX] = "Inbound_Fax";
		channels[CATY_WEBCHAT] = "Inbound_Webchat";
		channels[CATY_BLOG] = "Inbound_OthersMedia";
		channels[CATY_WHATSAPP] = "Inbound_Whatsapp";
		channels[CATY_FBMSG] = "Inbound_FBMsg";
		channels[CATY_FBPOST] = "Inbound_FBPost";

		var agentStatus = {};
		agentStatus[STATUS_LOGOUT] = "LOGOUT";
		agentStatus[STATUS_LOGIN] = "LOGIN";
		agentStatus[STATUS_IDLE] = "IDLE";
		agentStatus[STATUS_READY] = "READY";
		agentStatus[STATUS_BREAK] = "BREAK";
		agentStatus[STATUS_HOLD] = "HOLD";
		agentStatus[STATUS_TALKING] = "TALKING";
		agentStatus[STATUS_WORKING] = "WORKING";
		agentStatus[STATUS_DIALING] = "DIALING";
		agentStatus[STATUS_PLAYING] = "PLAYING";
		agentStatus[STATUS_MONITOR] = "MONITOR";

		//20241031 for sHandler
		var currentTicket = null;
		var currentTicketlist = null;
		var currentMsglist = null;
		var SelectedChannel = null;
		var SelectedDeviceID = null;
		var selectedQueuelist = null;
		var currentAgentList = null;

		var pastMsglist = null;

		var reloadedByGetTicket = false;
		var responseInvite = false;
		var AssignedTicketList = [];
		var JoinedConferenceList = [];
		var sendMessageReturned = null;
		var testMode = false;

		var ticketList = [];
		//ticketList.push({"ticket_id":"-2083549824"});
		var currSocialMsg = {};

		var sendMsgResult = { result: "", data: {} };
		var sendFileResult = { result: "", data: {} };
		var userMode = "";
		var agentStatusTimer;
		var inboundQueueTimer;
		var updateQueueTimer;
		var queueTimeTimer;			// 20250414 Add the "let", "const" or "var" keyword to this declaration of "queueTimeTimer" to make it explicit.

		var shandler; 				//20250414 Add the "let", "const" or "var" keyword to this declaration of "shandler" to make it explicit.
		//20250414 Add the "let", "const" or "var" keyword to this declaratio
		var caller = "";
		var answer = "";
		var connID = 0;
		var serviceID = 0;
		
		
		var queueList = [];
		var callType = 0;
		var callID = 0;
		var ANINo = "";
		var DNISNo = "";
		var ivrsMessage = "";
		var attachment = "";
		var currCallInfo = { lastCallType: 0, lastCallID: 0, confCallID: 0, callSeq: [] };			
		var currCallType = 0;
		var currCallID = 0;
		var currconnID = 0;
		var holdingConnIDs = [];
		var confConnID = 0;
		var isMakeConf = false;
		var mediaID = 0;
		var mediaFrom = "";
		var mediaTo = "";
		var mediaSubject = "";
		var ringAudio;
		var queAudio;
		var msgAudio;

		var localIP = "";

		var monAgentList = [];
		var monACDGroupList = [];
		var monCallStatusList = [];
		var monitoredAgentId = 0;
		var monitoredTicketList = [];

		var directCalls = [];

		var acdGroupMemberBy = "";

		var templateMsgResult = {};
		var templateMsgResultEx = [];
		var mediaCallMessage = [];

		var agentLevelID = 0;

		window.onclose = function () {
			wsWiseAgent.Logout();
		}

		window.onbeforeunload = function () {
			wsWiseAgent.Logout();
			wsWiseMonitor.CloseWebsocket();
			if (config.isWebRTC) {
				RTC.sipLogout();
			}
		}
		/*
		$(window).blur(function(){
			// do something when it loose focus like that:
			alert('Good Bye.');
		});

		$(window).focus(function(){
			// do something when it gains focus
			alert('Welcome back.');
		});
		*/

		var winOnFocus = true;

		var hidden, visibilityChange;
		if (typeof document.hidden !== "undefined") { // Opera 12.10 and Firefox 18 and later support
			hidden = "hidden";
			visibilityChange = "visibilitychange";
		} else if (typeof document.msHidden !== "undefined") {
			hidden = "msHidden";
			visibilityChange = "msvisibilitychange";
			visibilityChange = "msvisibilitychange";
		} else if (typeof document.webkitHidden !== "undefined") {
			hidden = "webkitHidden";
			visibilityChange = "webkitvisibilitychange";
		}

		var videoElement = document.getElementById("videoElement");

		// If the page is hidden, pause the video;
		// if the page is shown, play the video
		function handleVisibilityChange() {
			if (document[hidden]) {
				//videoElement.pause();
				winOnFocus = false;
				//alert('Good Bye.');
			} else {
				winOnFocus = true;
				//alert('Welcome back.');
			}
		}

		// Warn if the browser doesn't support addEventListener or the Page Visibility API
		if (typeof document.addEventListener === "undefined" || hidden === undefined) {
			console.log("This demo requires a browser, such as Google Chrome or Firefox, that supports the Page Visibility API.");
		} else {
			// Handle page visibility change
			document.addEventListener(visibilityChange, handleVisibilityChange, false);

			// When the video pauses, set the title.
			// This shows the paused


		}
		/*
		window.top.onblur = function(){
		  // do something when it loose focus like that:
			winOnFocus=false;
			//alert('Good Bye.');
		};

		window.top.onfocus = function(){
		  // do something when it loose focus like that:
			winOnFocus=true;
			alert('Welcome back.');
			console.log("winOnFocus=" + winOnFocus);
		};
		*/

		/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		///// Start----------------------------------------------------------New SHandler Session-----------------------------------------------------------------------////////
		/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

		function onTicketEvent(e) {

			console.log(e);

			//Remove all queueListItem that are created in sHandler
			queueList = queueList.filter(i => i.source != 'sleekflow');

			//20250403 Expected a `for-of` loop instead of a `for` loop
			for (let service of serviceList) {
				
				//let service = serviceList[i];		// 20250403 Expected a `for-of` loop instead of a `for` loop

				if (service.source == 'sleekflow') {
					let _list = e.filter(t => t.Channel == service.entry && t.DeviceId == service.deviceId);
					let a = queueList.findIndex(v => v.entry == service.entry && v.dnis == service.deviceId);
					if (a != -1) {
						queueList[a].waitCount = _list.length;
						selectedQueuelist[0].waitCount = _list.length;
					} 
					else {
						queueList.push({
							callType: service.callType, name: service.name, caption: service.caption, entry: service.entry, source: service.source,
							dnis: service.deviceId, showPriority: 0, waitTime: 0, waitCount: _list.length, 
						});
					}
				}
			}

			//ticketList.push(q);


			//Remove all queueListItem that waitCount is 0
			//queueList = queueList.filter(i=>i.source != 'sleekflow' && i.waitCount == 0);


			showQueueList();
		}

		function onMessageEvent(e) {
			parent.$('#social-media-main')[0].contentWindow.chatService.incomeMessageCallBack(e.details);
			console.log(e);
		}


		var invitedTicket = null;
		function onInteractEvent(e) {
			//{"type":"responseConference","details":{"targentAgentId":6,"ticketId":1023,"message":"RESPONSE YOU","agentResponse":"Y"}}

			//for handling conference with agent
			if (e.type == "requestConference") {
				invitedTicket = e.details.ticket;
				showBeInvitedModal(e);
				console.log(e);
			}

			if (e.type == "responseConference") {
				parent.$('#social-media-main')[0].contentWindow.chatService.sendInviteRequestcallBack(e);
				console.log(e);
			}

			if (e.type == "endTicket") {	//assignedTo: 5, closedBy: 5
				parent.$('#social-media-main')[0].contentWindow.chatService.receiveMessageForEndTicket(e.details);
				console.log(e);
			}

			if (e.type == "timeout") {
				parent.$('#social-media-main')[0].contentWindow.chatService.sessionTimeoutCallBack(e.details.ticketId);
				console.log(e);
			}

			if (e.type == "leaveConference") {
				parent.$('#social-media-main')[0].contentWindow.chatService.receiveMessageForMemberLeave(e.details.ticketId, e.details.leaveAgentId);
				console.log(e);
			}
		}

		function showBeInvitedModal(response) {
			var agent = top.agentList.filter(i => i.AgentID == response.details.requestAgentId)[0];
			var agentName = agent.AgentName;

			parent.window.$('#be-invited-campaign')[0].innerHTML = parent.window[1].campaign;
			parent.window.$('#be-invited-entry')[0].innerHTML = response.details.ticket.Channel;  // need ...............response.channel;
			parent.window.$('#be-invited-ticketid')[0].innerHTML = response.details.ticket.TicketId;

			parent.window.$('#be-invited-agent')[0].innerHTML = agentName + " (ID: <span id='be-invited-agentId'>" + response.details.requestAgentId + "</span>)";
			parent.window.$('#be-invited-request')[0].innerHTML = response.details.message.length > 0 ? response.details.message : '[empty]';
			parent.window.$('#beInvitedModal').modal('show');
		}

		function testInvite() {
			var responseText = '{"type":"requestConference","requestAgentId":5,"ticket":{"TicketId":419,"EndUserId":"037b1416-38c5-4c9e-aa4c-ce7dec02effa","EndUserProfileId":"53cf32e6-8914-4ffb-a935-fefb05caa9fd","EndUserName":"TEST","EndUserEmail":"TEST@TESTER.COM","EndUserPhone":"85291111111","AssignedTo":5,"Status":"open","Channel":"web","DeviceId":"","CreatedBy":"user","CreatedAt":"2024-11-27T09:58:11.51","UpdatedAt":"2024-11-27T09:58:24.383","LastMessage":"Message from tester 44"},"message":"wantInvite"}';
			var response = JSON.parse(responseText);
			showBeInvitedModal(response);
		}

		//For development and debug //20241031
		//--------------------------------------------------------------------------------
		function acceptCall_test(loginId, Token, Channel, deviceID) {
			testMode = true;

			//Function for redirect iframe to socialMedialHandler.html
			window.parent.SocialMediaClicked();


			var testAssignedList = '[{ "TicketId": 418, "EndUserId": "b5b6f193-0a3b-4560-aa33-573706309416", "EndUserProfileId": "53cf32e6-8914-4ffb-a935-fefb05caa9fd", "EndUserName": "TIGER", "EndUserEmail": "TIGER@TIGERTEST.COM", "EndUserPhone": "85291111111", "AssignedTo": 5, "Status": "open", "Channel": "web", "DeviceId": "", "CreatedBy": "user", "CreatedAt": "2024-11-27T09:54:24.763", "UpdatedAt": "2024-11-27T09:54:34.257", "LastMessage": "Message 3", "messages": ' +
				'[{ "MessageId": 2307930846, "TicketId": 418, "UniqueId": null, "QuotedMsgBody": "", "EndUserId": "b5b6f193-0a3b-4560-aa33-573706309416", "Channel": "web", "SentBy": "user", "UpdatedBy": null, "UpdatedAt": "2024-11-27T09:54:24.763", "MessageType": "text", "MessageContent": "MEssage 1", "FilesJson": "[]" }, ' +
				'{ "MessageId": 2307930870, "TicketId": 418, "UniqueId": null, "QuotedMsgBody": "",  "EndUserId": "b5b6f193-0a3b-4560-aa33-573706309416", "Channel": "web", "SentBy": "user", "UpdatedBy": null, "UpdatedAt": "2024-11-27T09:54:27.827", "MessageType": "text", "MessageContent": "Message 2", "FilesJson": "[]" }, ' +
				'{ "MessageId": 2307930871, "TicketId": 418, "UniqueId": null, "QuotedMsgBody": "",  "EndUserId": "b5b6f193-0a3b-4560-aa33-573706309416", "Channel": "web", "SentBy": "user", "UpdatedBy": null, "UpdatedAt": "2024-11-27T09:54:27.827", "MessageType": "text", "MessageContent": "Message 3", "FilesJson": "[]" }, ' +
				'{ "MessageId": 2307930872, "TicketId": 418, "UniqueId": null, "QuotedMsgBody": "",  "EndUserId": "b5b6f193-0a3b-4560-aa33-573706309416", "Channel": "web", "SentBy": "user", "UpdatedBy": null, "UpdatedAt": "2024-11-27T09:54:27.827", "MessageType": "text", "MessageContent": "Message 4", "FilesJson": "[]" }, ' +
				'{ "MessageId": 2307930873, "TicketId": 418, "UniqueId": null, "QuotedMsgBody": "",  "EndUserId": "b5b6f193-0a3b-4560-aa33-573706309416", "Channel": "web", "SentBy": "user", "UpdatedBy": null, "UpdatedAt": "2024-11-27T09:54:27.827", "MessageType": "text", "MessageContent": "Message 5", "FilesJson": "[]" }, ' +
				'{ "MessageId": 2307930874, "TicketId": 418, "UniqueId": null, "QuotedMsgBody": "",  "EndUserId": "b5b6f193-0a3b-4560-aa33-573706309416", "Channel": "web", "SentBy": "user", "UpdatedBy": null, "UpdatedAt": "2024-11-27T09:54:27.827", "MessageType": "text", "MessageContent": "Message 6", "FilesJson": "[]" }, ' +
				'{ "MessageId": 2307930875, "TicketId": 418, "UniqueId": null, "QuotedMsgBody": "",  "EndUserId": "b5b6f193-0a3b-4560-aa33-573706309416", "Channel": "web", "SentBy": "user", "UpdatedBy": null, "UpdatedAt": "2024-11-27T09:54:27.827", "MessageType": "text", "MessageContent": "Message 7", "FilesJson": "[]" }, ' +
				'{ "MessageId": 2307930876, "TicketId": 418, "UniqueId": null, "QuotedMsgBody": "",  "EndUserId": "b5b6f193-0a3b-4560-aa33-573706309416", "Channel": "web", "SentBy": "user", "UpdatedBy": null, "UpdatedAt": "2024-11-27T09:54:27.827", "MessageType": "text", "MessageContent": "Message 8", "FilesJson": "[]" }, ' +
				'{ "MessageId": 2307930877, "TicketId": 418, "UniqueId": null, "QuotedMsgBody": "",  "EndUserId": "b5b6f193-0a3b-4560-aa33-573706309416", "Channel": "web", "SentBy": "user", "UpdatedBy": null, "UpdatedAt": "2024-11-27T09:54:27.827", "MessageType": "text", "MessageContent": "Message 9", "FilesJson": "[]" }, ' +
				'{ "MessageId": 2307930878, "TicketId": 418, "UniqueId": null, "QuotedMsgBody": "",  "EndUserId": "b5b6f193-0a3b-4560-aa33-573706309416", "Channel": "web", "SentBy": "user", "UpdatedBy": null, "UpdatedAt": "2024-11-27T09:54:27.827", "MessageType": "text", "MessageContent": "Message 10", "FilesJson": "[]" }, ' +
				'{ "MessageId": 2307930879, "TicketId": 418, "UniqueId": null, "QuotedMsgBody": "",  "EndUserId": "b5b6f193-0a3b-4560-aa33-573706309416", "Channel": "web", "SentBy": "user", "UpdatedBy": null, "UpdatedAt": "2024-11-27T09:54:27.827", "MessageType": "text", "MessageContent": "Message 11", "FilesJson": "[]" }, ' +
				'{ "MessageId": 2307930880, "TicketId": 418, "UniqueId": null, "QuotedMsgBody": "",  "EndUserId": "b5b6f193-0a3b-4560-aa33-573706309416", "Channel": "web", "SentBy": "user", "UpdatedBy": null, "UpdatedAt": "2024-11-27T09:54:27.827", "MessageType": "text", "MessageContent": "Message 12", "FilesJson": "[]" }, ' +
				'{ "MessageId": 2307930881, "TicketId": 418, "UniqueId": null, "QuotedMsgBody": "",  "EndUserId": "b5b6f193-0a3b-4560-aa33-573706309416", "Channel": "web", "SentBy": "user", "UpdatedBy": null, "UpdatedAt": "2024-11-27T09:54:27.827", "MessageType": "text", "MessageContent": "Message 13", "FilesJson": "[]" }, ' +
				'{ "MessageId": 2307930882, "TicketId": 418, "UniqueId": null, "QuotedMsgBody": "",  "EndUserId": "b5b6f193-0a3b-4560-aa33-573706309416", "Channel": "web", "SentBy": "user", "UpdatedBy": null, "UpdatedAt": "2024-11-27T09:54:27.827", "MessageType": "text", "MessageContent": "Message 14", "FilesJson": "[]" }, ' +
				'{ "MessageId": 2307930883, "TicketId": 418, "UniqueId": null, "QuotedMsgBody": "",  "EndUserId": "b5b6f193-0a3b-4560-aa33-573706309416", "Channel": "web", "SentBy": "user", "UpdatedBy": null, "UpdatedAt": "2024-11-27T09:54:27.827", "MessageType": "text", "MessageContent": "Message 15", "FilesJson": "[]" }, ' +
				'{ "MessageId": 2307930925, "TicketId": 418, "UniqueId": null, "QuotedMsgBody": "",  "EndUserId": "b5b6f193-0a3b-4560-aa33-573706309416", "Channel": "web", "SentBy": "user", "UpdatedBy": null, "UpdatedAt": "2024-11-27T09:54:34.257", "MessageType": "text", "MessageContent": "Message 16", "FilesJson": "[]" }] },' +

				'{ "TicketId": 419, "EndUserId": "037b1416-38c5-4c9e-aa4c-ce7dec02effa", "EndUserProfileId": "53cf32e6-8914-4ffb-a935-fefb05caa9fd", "EndUserName": "TEST", "EndUserEmail": "TEST@TESTER.COM", "EndUserPhone": "85291111111", "AssignedTo": 5, "Status": "open", "Channel": "web", "DeviceId": "", "CreatedBy": "user", "CreatedAt": "2024-11-27T09:58:11.51", "UpdatedAt": "2024-11-27T09:58:24.383", "LastMessage": "Message from tester 44", "messages": [{ "MessageId": 2307932310, "TicketId": 419, "UniqueId": null, "QuotedMsgBody": "", "EndUserId": "037b1416-38c5-4c9e-aa4c-ce7dec02effa", "Channel": "web", "SentBy": "user", "UpdatedBy": null, "UpdatedAt": "2024-11-27T09:58:11.51", "MessageType": "text", "MessageContent": "Message from tester 1", "FilesJson": "[]" }, { "MessageId": 2307932360, "TicketId": 419, "UniqueId": null, "QuotedMsgBody": "", "EndUserId": "037b1416-38c5-4c9e-aa4c-ce7dec02effa", "Channel": "web", "SentBy": "user", "UpdatedBy": null, "UpdatedAt": "2024-11-27T09:58:18.937", "MessageType": "text", "MessageContent": "Message from tester 2", "FilesJson": "[]" }, { "MessageId": 2307932376, "TicketId": 419, "UniqueId": null, "QuotedMsgBody": "", "EndUserId": "037b1416-38c5-4c9e-aa4c-ce7dec02effa", "Channel": "web", "SentBy": "user", "UpdatedBy": null, "UpdatedAt": "2024-11-27T09:58:21.74", "MessageType": "text", "MessageContent": "Message from tester 33", "FilesJson": "[]" }, { "MessageId": 2307932391, "TicketId": 419, "UniqueId": null,"QuotedMsgBody": "",  "EndUserId": "037b1416-38c5-4c9e-aa4c-ce7dec02effa", "Channel": "web", "SentBy": "user", "UpdatedBy": null, "UpdatedAt": "2024-11-27T09:58:24.383", "MessageType": "text", "MessageContent": "Message from tester 44", "FilesJson": "[]" }] },' +
				'{ "TicketId": 420, "EndUserId": "b5b6f193-0a3b-4560-aa33-573706309416", "EndUserProfileId": "53cf32e6-8914-4ffb-a935-fefb05caa9fd", "EndUserName": "MARY", "EndUserEmail": "MARY@MARY.COM", "EndUserPhone": "85291111111", "AssignedTo": 5, "Status": "closed", "Channel": "web", "DeviceId": "", "CreatedBy": "user", "CreatedAt": "2024-12-02T14:54:24.363", "UpdatedAt": "2024-12-02T14:54:34.257", "LastMessage": "Message 3", "messages": [{ "MessageId": 2307930846, "TicketId": 420, "UniqueId": null, "QuotedMsgBody": "", "EndUserId": "b5b6f193-0a3b-4560-aa33-573706309416", "Channel": "web", "SentBy": "user", "UpdatedBy": null, "UpdatedAt": "2024-11-27T09:54:24.763", "MessageType": "text", "MessageContent": "MEssage 1", "FilesJson": "[]" }, { "MessageId": 2307930870, "TicketId": 420, "UniqueId": null, "QuotedMsgBody": "", "EndUserId": "b5b6f193-0a3b-4560-aa33-573706309416", "Channel": "web", "SentBy": "user", "UpdatedBy": null, "UpdatedAt": "2024-11-27T09:54:27.827", "MessageType": "text", "MessageContent": "Message 2", "FilesJson": "[]" }, { "MessageId": 2307930925, "TicketId": 420, "UniqueId": null, "QuotedMsgBody": "", "EndUserId": "b5b6f193-0a3b-4560-aa33-573706309416", "Channel": "web", "SentBy": "user", "UpdatedBy": null, "UpdatedAt": "2024-12-02T14:54:34.257", "MessageType": "text", "MessageContent": "Message 3", "FilesJson": "[]" }] }]';




			//var testQueueList = '[{ "callType": 16, "name": "campaignCRM", "caption": "EPRO", "entry": "whatsapp", "source": "sleekflow", "dnis": "85293909352", "showPriority": 0, "waitTime": 0, "waitCount": 0 }, { "callType": 10, "name": "campaignCRM", "caption": "EPRO", "entry": "web", "source": "sleekflow", "dnis": "", "showPriority": 0, "waitTime": 0, "waitCount": 0 }, { "callType": 7, "acdGroup": 1, "entry": "", "name": "campaignCRM", "caption": "9000", "dnis": "9000", "showPriority": 1, "waitTime": 582820, "waitCount": 1, "mediaCount": 0 }, { "callType": 6, "acdGroup": 7, "name": "campaignCRM", "caption": "EPRO", "dnis": "demo-cpb@eprotel.com.hk", "showPriority": 2, "waitTime": 632525, "waitCount": 1, "mediaCount": 17 }, { "callType": 7, "acdGroup": 1, "name": "campaignCRM", "caption": "9001", "dnis": "9001", "showPriority": 2, "waitTime": 582821, "waitCount": 0, "mediaCount": 2 }]';
			AssignedTicketList = JSON.parse(testAssignedList);

			//queueList = JSON.parse(testQueueList);

			selectedQueuelist = queueList.filter(i => i.source == 'sleekflow' && i.entry == 'web');


			//JSON.parse(JSON.stringify(parent.$('#phone-panel')[0].contentWindow.AssignedTicketList));


			//var chatService= parent.$('#social-media')[0].contentWindow.chatService;
			//chatService.addMessage();
		}

		var inviteTicketId = "";
		var inviteTargetAgentId = "";
		var inviteMessage = "";
		var inviteAgentResponse = "N";
		function responseInvitedCall(isAccept) {
			//check websocket state, continue process is not allowed if false is returned;
			var wssresult = checkWebSocketState(shandler.websocket);
			//if (wssresult.result == false) { alert(wssresult.message); return; }	// 20250407 Refactor the code to avoid using this boolean literal.
			if (!wssresult.result) { alert(wssresult.message); return; }
			//-----

			inviteTicketId = parent.window.$('#be-invited-ticketid')[0].innerHTML;
			inviteTargetAgentId = parent.window.$('#be-invited-agentId')[0].innerHTML;
			inviteMessage = parent.window.$('#be-invited-message').val();
			inviteAgentResponse = "N";

			if (isAccept) {
				inviteAgentResponse = "Y";
				currentTicket = invitedTicket;
				currentTicket.messages = [];
				AssignedTicketList.push(currentTicket);
				//queueList = JSON.parse(testQueueList);

				window.parent.SocialMediaClicked();


				//Call the function after load the page

				reloadedByGetTicket = true;
				responseInvite = true;

			}

			//$('#beInvitedModal').modal('toggle');
		}
		let runCount = 0;


		function responseInviteCallBack(ticketId, response) {

			if (response == 'Y') {
				parent.window.$('#beInvitedModal').blur();			// 20250328 Expected an assignment or function call and instead saw an expression.
				parent.window.$('#beInvitedModal').modal('hide');
				//responseInviteByHandler(parseInt(agentId), token, parseInt(ticketId), parseInt(targetAgentId), message, agentResponse);
				responseInvite = false;
				parent.$('#social-media-main')[0].contentWindow.chatService.updateChatForResponseInviteCallBack(ticketId);
			}
			//acceptCall_fromConference(response);
		}

		function acceptCall_fromConference(response) {


			//parent.$('#social-media-main')[0].contentWindow.chatService.updateChatHeader(invitedTicket.Channel, invitedTicket);
			//parent.$('#social-media-main')[0].contentWindow.chatService.resetChatHistory();

			//  this.updateChatHeader(selectedTicket[0].Channel, selectedTicket[0]);


		}

		// Function that trigger by user click the querylist on the top
		function acceptCall_Shandler(loginId, Token, Channel, deviceID) {
			//check websocket state, continue process is not allowed if false is returned;
			// var wssresult = checkWebSocketState(shandler.websocket);
			// if (wssresult.result == false) { alert(wssresult.message); return; }
			//-----

			var ticket = null;
			var msg = null;

			//Step 1: get the ticket
			shandler.getTicket({
				agentid: loginId,
				token: Token,
				channel: Channel,
				deviceid: deviceID
			})
				.then(response => {
					if (response.result == "success") {

						if (response.details.ticket != null) {
							if (shandler.tickets.length != 0) {

								//let _messagelist = response.details.messages.filter(t => t.TicketId == shandler.tickets[shandler.tickets.length-1].TicketId);



								let _messagelist = response.details.messages.filter(t => t.TicketId == response.details.ticket.TicketId);

								//at the sorting for store message list first come first store
								_messagelist = _messagelist.sort((a, b) => { return a.MessageId - b.MessageId; });


								// createOrUpdateBubbleFromHandler(shandler.tickets[0], _messagelist);
								// if (_messagelist == null)
								// {
								//		shandler.tickets[0].shift;
								//  }

								//Function for redirect iframe to socialMedialHandler.html
								window.parent.SocialMediaClicked();

								currentTicket = response.details.ticket;

								//For Show last message in ticket double list
								currentTicket.LastMessage = _messagelist[_messagelist.length - 1].MessageContent;

								//currentTicketlist = [].concat(shandler.tickets);
								_messagelist.forEach(item => { item.oTicketId = item.TicketId; });

								currentMsglist = _messagelist;


								//Will be reset if other channel with different different id is selected;
								selectedQueuelist = queueList.filter(i => i.source == 'sleekflow' && i.entry == Channel && i.dnis == deviceID);


								//All the chatService reload the ticket screen



								const assignedTicket = { ...currentTicket };	//const assignedTicket = Object.assign({}, currentTicket);	//20250409 Use an object spread instead of `Object.assign`

								assignedTicket.messages = _messagelist;

								//Area for handling data
								if (assignedTicket.Channel == "whatsapp") {
									assignedTicket.EndUserPhone = _messagelist[0].EndUserId;
									currentTicket.EndUserPhone = _messagelist[0].EndUserId;
								}

								AssignedTicketList.push(assignedTicket);


								reloadedByGetTicket = true;
								responseInvite = false;

								pastMsglist = null;

								//var limit = "500";
								//shandler.getMessagesByUserId({
								//    agentid: loginId,
								//    token: Token,
								//    userId: currentTicket.EndUserId,
								//    msgId: _messagelist[_messagelist.length - 1].msgId,
								//    limit, limit,
								//    deviceid: deviceID
								//})
								//    .then(response => {
								//        pastMsglist = response.details.messages;
								//    })
								//    .catch(error => {

								//        console.log(error);
								//        return null;
								//    });

							}



						}
						//triggerEvent(window.parent.document, 'onWiseSocialMsg', );
					}
				})
				.catch(error => {
					console.log(error);
				});

			//-------------------------------------------//
			//agentid, token, ticketId,

			//			Msg object field name

			//         id: new Date().getUTCMilliseconds(),
			//         'nick_name': agentName,
			//         'send_by_flag': 1,							//發送者1:客服,2:enduser{			*****NEED all the message list for update bubble
			//         'sent_time': getSqlFormatTime(),
			//         msg_type: "text",
			//         msg_content: fileDetails.FileName + " failed to send to the customer<br>[THIS MESSAGE WILL NOT BE SHOWN IN CUSTOMER'S WINDOW]",
			//         isSuccess: false

			//		"MessageId": 2281386826,	<= ID
			//		"TicketId": 26,
			//		"UniqueId": null,
			//		"EndUserId": "537e41bd-d962-4244-a8bf-804b0803937d",
			//		"Channel": "web",
			//		"SentBy": "user",
			//		"UpdatedBy": null,
			//		"UpdatedAt": "2024-10-30T09:40:42.933",		<=sent_time'
			//		"MessageType": "text",
			//		"MessageContent": "AAAAA",
			//		"FilesJson": "[]"

			//		AgentiD???
		}


		//function sendMessageByHandler(agent, token, channel, webClientSenderId, messageType, messageContent, ticketId)
		function sendMessageByHandler(agent, token, messageType, messageContent, sTicket) {
			//check websocket state, continue process is not allowed if false is returned;
			var wssresult = checkWebSocketState(shandler.websocket);
			//if (wssresult.result == false) { alert(wssresult.message); return; }		// 20250407 Refactor the code to avoid using this boolean literal.
			if (!wssresult.result) { alert(wssresult.message); return; }
			//-----

			//Default example
			//let formData = new FormData();
			//formData.append('agentId', 111);
			//formData.append('token', 'xxx');
			//formData.append('ticketId', 112);
			//formData.append('channel', 'web');
			//formData.append('WebClientSenderId', '11120-232-42323');      //user id
			//formData.append('messageType', 'file');               //file or text
			//	formData.append('messageContent', 'hello');
			//	formData.append('files', file);

			var channel = sTicket.Channel;
			// Create a FormData object
			let formData = new FormData();

			// Append input field values to the FormData object

			if (channel == "web") {
				formData.append('agentId', agent);
				formData.append('token', token);
				formData.append('ticketId', sTicket.TicketId);
				formData.append('channel', sTicket.Channel);
				formData.append('webClientSenderId', sTicket.EndUserId);
				formData.append('messageType', messageType);
				formData.append('messageContent', messageContent);
				//formData.append('files',			file);
			}
			if (channel == "whatsapp") {

				formData.append('agentId', agent);
				formData.append('token', token);
				formData.append('ticketId', sTicket.TicketId);
				//formData.append('channel', sTicket.Channel);
				formData.append('channel', "whatsappcloudapi");


				//formData.append('webClientSenderId', sTicket.webClientSenderId);

				formData.append('from', sTicket.DeviceId);
				formData.append('to', sTicket.EndUserPhone);

				formData.append('messageType', messageType);
				formData.append('messageContent', messageContent);


			}


			shandler.sendMessage(formData)
				.then(response => {
					if (response != null) {
						sendMessageReturned = response;
						parent.$('#social-media-main')[0].contentWindow.chatService.sendMessageCallBack(sendMessageReturned);
					}
				})
				.catch(error => {

					console.log(error);
					return null;
				});
		}



		function sendAttachmentByHandler(agent, token, messageType, file, sTicket) {

			//check websocket state, continue process is not allowed if false is returned;
			var wssresult = checkWebSocketState(shandler.websocket);
			//if (wssresult.result == false) { alert(wssresult.message); return; }	// 20250407 Refactor the code to avoid using this boolean literal.
			if (!wssresult.result) { alert(wssresult.message); return; }
			//-----

			//Default example
			//let formData = new FormData();
			//formData.append('agentId', 111);
			//formData.append('token', 'xxx');
			//formData.append('ticketId', 112);
			//formData.append('channel', 'web');
			//formData.append('WebClientSenderId', '11120-232-42323');      //user id
			//formData.append('messageType', 'file');               //file or text
			//	formData.append('messageContent', 'hello');
			//	formData.append('files', file);

			var channel = sTicket.Channel;

			// Create a FormData object
			let formData = new FormData();

			// Append input field values to the FormData object
			if (channel == "web") {
				formData.append('agentId', agent);
				formData.append('token', token);
				formData.append('ticketId', sTicket.TicketId);
				formData.append('channel', sTicket.Channel);
				formData.append('webClientSenderId', sTicket.EndUserId);
				formData.append('messageType', messageType);
				formData.append('messageContent', "");
				formData.append('files', file);
			}

			if (channel == "whatsapp") {

				formData.append('agentId', agent);
				formData.append('token', token);
				formData.append('ticketId', sTicket.TicketId);
				//formData.append('channel', sTicket.Channel);
				formData.append('channel', "whatsappcloudapi");

				//formData.append('webClientSenderId', sTicket.webClientSenderId);

				formData.append('from', sTicket.DeviceId);
				formData.append('to', sTicket.EndUserPhone);

				formData.append('messageType', messageType);
				formData.append('messageContent', "");
				formData.append('files', file);

			}

			// FOR DEBUG
			//var object = {};
			//formData.forEach(function (value, key) {        object[key] = value;    });
			//var json = JSON.stringify(object);

			//console.log(json);

			shandler.sendMessage(formData)
				.then(response => {
					if (response != null) {
						sendMessageReturned = response;
						parent.$('#social-media-main')[0].contentWindow.chatService.sendMessageCallBack(sendMessageReturned);
					}
				})
				.catch(error => {

					console.log(error);
					return null;
				});
		}

		function getPastMessageByHandler(ticketId, agentid, token, userId, msgId, limit) {
			//check websocket state, continue process is not allowed if false is returned;
			var wssresult = checkWebSocketState(shandler.websocket);
			//if (wssresult.result == false) { alert(wssresult.message); return; }	// 20250407 Refactor the code to avoid using this boolean literal.
			if (!wssresult.result) { alert(wssresult.message); return; }
			//-----

			$.ajax({	//parent.$('#phone-panel')[0].contentWindow.shandler.apiUrl 'http://172.17.6.11:8033'
				type: "POST",
				url: shandler.apiUrl + '/api/GetMessagesByUserId', crossDomain: true,
				data: JSON.stringify({ AgentId: agentid, Token: token, UserId: userId, MsgId: msgId, Limit: limit }),
				contentType: "application/json; charset=utf-8", dataType: "json",
				success: function (r) {
					if (!/^success$/i.test(r.result || "")) {
						console.log('error in function getPastMessageByHandler');
						console.log(r);
					} else {  //cannot use this.selectedTicketId because the function is tiggerd in popup

						//console.log(JSON.stringify(r.details));
						parent.$('#social-media-main')[0].contentWindow.chatService.returnPastMessageByTicketIdCallBack(ticketId, r.details);

					}
				},
				error: function (r) {
					console.log('error in getPastMessageByHandler');
					console.log(r);
				}
			});

		}

		//	function sendTemplateMessageByHandler(agent, token, companyName, sTemplate, sTicket) {
		//****20250116 same API defined in crmInputForm .js*/
		function sendTemplateMessageByHandler(agent, token, companyName, sTemplate, sFrom, sTo, sTicketId) {

			//check websocket state, continue process is not allowed if false is returned;
			var wssresult = checkWebSocketState(shandler.websocket);
			//if (wssresult.result == false) { alert(wssresult.message); return; }	// 20250407 Refactor the code to avoid using this boolean literal.
			if (!wssresult.result) { alert(wssresult.message); return; }
			//-----

			$.ajax({
				type: "POST",
				url: shandler.apiUrl + '/api/sendTemplate', crossDomain: true,
				data:
					JSON.stringify({
						"Agent_Id": agent,
						"TicketId": sTicketId,
						"Token": token,
						"Company": companyName,
						"TemplateName": sTemplate.TemplateName,
						"From": sFrom,
						"To": sTo,
						"BodyParams": sTemplate.inputList
					}),
				contentType: "application/json; charset=utf-8", dataType: "json",
				success: function (r) {
					if (!/^success$/i.test(r.result || "")) {
						console.log('error in function sendTemplateMessageByHandler');
					//} else {  // 20250410 'If' statement should not be the only statement in 'else' block
					} else if (sTicketId != null) {
							//Send from chatbot
							parent.$('#social-media-main')[0].contentWindow.chatService.sendMessageByTemplateCallBack(r.details);
						//} // //20250410 for else if

						//cannot use this.selectedTicketId because the function is tiggerd in popup
						//var sTicketId = parent.$('#social-media-main')[0].contentWindow.chatService.selectedTicketId;
						//parent.$('#social-media-main')[0].contentWindow.chatService.requestCannedFileInBase64CallBack(fileId, fileName, fileType, r.data.FileBase64, sTicketId);
					}
				},
				error: function (r) {
					console.log('error in sendTemplateMessageByHandler');
					console.log(r);
				}
			});


		}
		function requestCannedFileInBase64ByHandler(fileId, fileName, fileType) {
			//check websocket state, continue process is not allowed if false is returned;
			var wssresult = checkWebSocketState(shandler.websocket);
			//if (wssresult.result == false) { alert(wssresult.message); return; }		// 20250407	Refactor the code to avoid using this boolean literal.
			if (!wssresult.result) { alert(wssresult.message); return; }
			//-----

			var api = shandler.apiUrl.replace("8033", "");

			$.ajax({
				type: "POST",

				url: api + '/shandler/api/socialmedia/GetCannedFiles', crossDomain: true,
				data: JSON.stringify({ "company": 'EPRO', "fileId": fileId }), contentType: "application/json; charset=utf-8", dataType: "json",
				success: function (r) {
					if (!/^success$/i.test(r.result || "")) {
						console.log('error in sendCannedFileByHandler');
					} else {  //cannot use this.selectedTicketId because the function is tiggerd in popup
						var sTicketId = parent.$('#social-media-main')[0].contentWindow.chatService.selectedTicketId;
						parent.$('#social-media-main')[0].contentWindow.chatService.requestCannedFileInBase64CallBack(fileId, fileName, fileType, r.data.FileBase64, sTicketId);
					}
				},
				error: function (r) {
					console.log('error in sendCannedFileByHandler');
					console.log(r);
				}
			});
		};


		function endSessionByHandler(loginId, token, ticketId) {
			//check websocket state, continue process is not allowed if false is returned;
			//  var wssresult = checkWebSocketState(shandler.websocket);
			//  if (wssresult.result == false) { alert(wssresult.message); return; }
			//-----

			// Append input field values to the FormData object

			//agentid, token, ticketid

			shandler.endTicket({
				agentid: loginId,
				token: token,
				ticketid: ticketId
			})
				.then(response => {
					if (response) {
						parent.$('#social-media-main')[0].contentWindow.chatService.endSessionCallBack(ticketId);
					}
				})
				.catch(error => {
					console.log('error in endSessionByHandler');
					console.log(error);
					return null;
				});
		}


		function returnCaseHistoryFromHandler(agentId, token, ticketId) {
			//check websocket state, continue process is not allowed if false is returned;
			var wssresult = checkWebSocketState(shandler.websocket);
			//if (wssresult.result == false) { alert(wssresult.message); return; }		// 20250407 Refactor the code to avoid using this boolean literal
			if (!wssresult.result) { alert(wssresult.message); return; }
			//-----

			shandler.getMessagesByTicketId({
				agentid: agentId,
				token: token,
				ticketId: ticketId
			})
				.then(response => {

					if (response != null) {
						console.log("getMessagesByTicketId: ");
						//   var msg_list = response.details.msg_list;
						//sort in ascending
						response = response.sort((a, b) => { return a.MessageId - b.MessageId; });

						//parent.$('#social-media-main')[0].contentWindow.chatService.returnPastMessageByTicketIdCallBack(ticketId, lastApiResult);
						parent.$('#phone-panel')[0].contentWindow.caHistService.returnCaseHistoryCallBack(response);
						//lastApiResult = null;			//20250414 remove the unused variable

					}
				})
				.catch(error => {
					console.log(error);
				});

		}

		// Conference Inviter side
		function inviteAgentByHandler(agentId, token, ticketId, targetAgentId, message) {
			//check websocket state, continue process is not allowed if false is returned;
			var wssresult = checkWebSocketState(shandler.websocket);
			//if (wssresult.result == false) { alert(wssresult.message); return; }		// 20250407 Refactor the code to avoid using this boolean literal
			if (!wssresult.result) { alert(wssresult.message); return; }
			//-----

			shandler.requestConference({
				agentId: agentId,
				token: token,
				ticketId: ticketId,
				targetAgentId: targetAgentId,
				message: message
			})
				.then(response => {

					if (response != null) {
						console.log("inviteAgentByHandler: ");

						//Need to need if the return is not valid
						if (response.result != 'success') {
							parent.$('#social-media-main')[0].contentWindow.chatService.sendInviteRequestcallBack(response);
							//inviteAgentCallBack(response);
						}

					}
				})
				.catch(error => {
					console.log(error);
				});
		}

		// Conference invitee side
		//function responseInviteByHandler(agentId, token, ticketId, requestAgentId, message, agentResponse)
		function responseInviteByHandler() {



			//check websocket state, continue process is not allowed if false is returned;
			var wssresult = checkWebSocketState(shandler.websocket);
			//if (wssresult.result == false) { alert(wssresult.message); return; }		// 20250407 Refactor the code to avoid using this boolean literal
			if (!wssresult.result) { alert(wssresult.message); return; }
			//-----
			var agentId = loginId; var requestAgentId = parseInt(inviteTargetAgentId); var agentResponse = inviteAgentResponse;
			var token = top.token; var ticketId = parseInt(inviteTicketId); var message = inviteMessage;

			//agentResponse: Y/N
			shandler.responseConference({
				agentId: agentId,
				token: token,
				ticketId: ticketId,
				requestAgentId: requestAgentId,
				message: message,
				agentResponse: agentResponse
			})
				.then(response => {

					if (response != null) {
						console.log("responseInviteByHandler: ");

						if (response.result == 'success') {
							responseInviteCallBack(ticketId, agentResponse);
						}

					}
				})
				.catch(error => {
					console.log(error);
				});
		}
		// for invited agent drop the bubble and set status to "leave"
		function leaveConferenceByHandler(leaveAgentId, token, ticketId) {
			//check websocket state, continue process is not allowed if false is returned;
			var wssresult = checkWebSocketState(shandler.websocket);
			//if (wssresult.result == false) { alert(wssresult.message); return; }		// 20250407 Refactor the code to avoid using this boolean literal
			if (!wssresult.result) { alert(wssresult.message); return; }
			//-----

			var agentId = leaveAgentId; var token = token; var ticketId = parseInt(ticketId);

			shandler.leaveConference({
				agentId: agentId,
				token: token,
				ticketId: ticketId
			})
				.then(response => {

					if (response != null) {
						console.log("leaveConferenceByHandler: ");


						parent.$('#social-media-main')[0].contentWindow.chatService.leaveChatCallBack(response);
					}
				})
				.catch(error => {
					console.log(error);
				});
		}

		function checkWebSocketState(websocket) {
            var result = null;		// var result = true;		//20250326	Review this redundant assignment:
			var message = "";

			switch (websocket.readyState) {
				case WebSocket.CONNECTING:
					message = "WebSocket is connecting...";
					result = true;
					break;
				case WebSocket.OPEN:
					message = 'WebSocket is open.';
					result = true;
					break;
				case WebSocket.CLOSING:
					message = 'WebSocket is closing...';
					result = false;
					break;
				case WebSocket.CLOSED:
					message = 'WebSocket is closed.';
					result = false;
					break;
				default:
					message = 'Unknown WebSocket state.';
					result = false;
					break;
			}
			console.log(message);

			return {
				result: result,
				message: message
			}
		}

		//------------------------------



		function addTestMessageAtTop() {



			var messageToAdd = '[{ "MessageId": 2307920846, "TicketId": 410, "UniqueId": null, "EndUserId": "b5b6f193-0a3b-4560-aa33-573706309416", "Channel": "web", "SentBy": "user", "UpdatedBy": null, "UpdatedAt": "2024-11-27T09:54:24.763", "MessageType": "text", "MessageContent": "MEssage 111", "FilesJson": "[]" }, ' +
				'{ "MessageId": 2307920870, "TicketId": 410, "UniqueId": null, "EndUserId": "b5b6f193-0a3b-4560-aa33-573706309416", "Channel": "web", "SentBy": "user", "UpdatedBy": null, "UpdatedAt": "2024-11-27T09:54:27.827", "MessageType": "text", "MessageContent": "Message 112", "FilesJson": "[]" }, ' +
				'{ "MessageId": 2307920871, "TicketId": 412, "UniqueId": null, "EndUserId": "b5b6f193-0a3b-4560-aa33-573706309416", "Channel": "web", "SentBy": "user", "UpdatedBy": null, "UpdatedAt": "2024-11-27T09:54:27.827", "MessageType": "text", "MessageContent": "Message 113", "FilesJson": "[]" }, ' +
				'{ "MessageId": 2307920925, "TicketId": 412, "UniqueId": null, "EndUserId": "b5b6f193-0a3b-4560-aa33-573706309416", "Channel": "web", "SentBy": "user", "UpdatedBy": null, "UpdatedAt": "2024-11-27T09:54:34.257", "MessageType": "text", "MessageContent": "Message 116", "FilesJson": "[]" }]'


			var msgList = JSON.parse(messageToAdd);


			parent.$('#social-media-main')[0].contentWindow.chatService.returnPastMessageByTicketIdCallBack(418, msgList);


		}





		/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		///// End----------------------------------------------------------New SHandler Session-----------------------------------------------------------------------////////
		/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


		async function windowOnload() {
			//console.log(new Date().getTime());
			var w = $(window).width();
			// $('.container').css('width', w-300);
			ringAudio = document.getElementById("ringAudio");
			queAudio = document.getElementById("queAudio");
			msgAudio = document.getElementById("msgAudio");

			//ringAudio.play();
			//console.log(ringing.duration);
			agentStatusTimer = window.setInterval("AgentStatusTicker()", 1000, "javascript");
			window.clearInterval(agentStatusTimer);
			inboundQueueTimer = window.setInterval("inboundQueueTicker()", 1000, "javascript");
			//window.clearInterval(agentStatusTimer);
			queueTimeTimer = window.setInterval("queueTimeTicker()", 1000, "javascript");

			if (config.isWebRTC) {
				setTimeout(function () { RTC.sipLogin(); }, 1000); // wait till api loaded
			}
			//window.clearInterval(queueTimer);
			//wsWiseAgent.OpenWebsocket(WISESERVER);
			/*
			window.RTCPeerConnection = window.RTCPeerConnection || window.mozRTCPeerConnection || window.webkitRTCPeerConnection;//compatibility for Firefox and chrome
			var pc = new RTCPeerConnection({iceServers:[]}), noop = function(){};
			pc.createDataChannel('');//create a bogus data channel
			pc.createOffer(pc.setLocalDescription.bind(pc), noop);// create offer and set local description
			pc.onicecandidate = function(ice)
			{
				if (ice && ice.candidate && ice.candidate.candidate)
				{
					localIP = /([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/.exec(ice.candidate.candidate)[1];
					//console.log('my IP: ', localIP);
					pc.onicecandidate = noop;
					wsWiseAgent.OpenWebsocket(WISESERVER);
				}
			};
			*/
			wsWiseAgent.OpenWebsocket(WISESERVER);
			/*
			shandler=await wsSHandler.create("172.17.2.34",loginId,top.token, false, {
				onTicketEvent,
				onMessageEvent
			});

			shandler.onOpenWebsocket=(e)=>console.log(e);
			shandler.onTicketsUpdated=(e)=>console.log(e);
			shandler.connect();
			*/
			shandler = await WSSHandler.create({
				hostname: "172.17.6.11",
				agentid: loginId,
				agentname: top.agentName,
				token: top.token,
				tls: false,
				listener: {
					onTicketEvent: onTicketEvent,
					onMessageEvent: onMessageEvent,
					onInteractEvent: onInteractEvent,
				}
			});
			console.log(shandler.tickets);
			/*
			var layout = queueLayout[CATY_FBMSG];

			var objImg = document.createElement("img");
				objImg.setAttribute("style",layout.style);
				objImg.src=layout.image;


			softPhone.appendChild(objImg);

			var layout1 = queueLayout[CATY_FBPOST];

			var objImg1 = document.createElement("img");
				objImg1.setAttribute("style",layout1.style);
				objImg1.src=layout1.image;


			softPhone.appendChild(objImg1);

			var layout2 = queueLayout[CATY_WECHAT];

			var objImg2 = document.createElement("img");
				objImg2.setAttribute("style",layout2.style);
				objImg2.src=layout2.image;


			softPhone.appendChild(objImg2);
			*/
		}

		// wsMonitor Start
		document.addEventListener("OnRMopen", function (e) {
			setTimeout(function () {
				wsWiseMonitor.Login(loginId, loginId);
			}, 1000);
		});

		document.addEventListener("onRMclose", function (e) {
			setTimeout(function () { wsWiseMonitor.OpenWebsocket(WISEIP); }, 1000);
		});

		document.addEventListener("onRMCommandSuccess", function (e) {
			var obj = e.detail;
			//console.log(obj);
			if (obj.ResultCommand == 107) { //Login
				//wsWiseMonitor.StartMonitor(20);
				/*
				wiseGetWhatsappMsg("campaignCRM", "2020-5-1", "2020-5-22", "", function(obj){
					console.log(obj);
				});
				*/

				wsWiseMonitor.StartMonitor(3); // agent
				wsWiseMonitor.StartMonitor(2); // acd group
				wsWiseAgent.StartMonitor(6);	//for social media
				wsWiseMonitor.StartMonitor(20); // Call IVRS - shows the queue how many people waiting in IVRS
				wsWiseMonitor.StartMonitor(21);
				setTimeout(function () { wsWiseMonitor.StopMonitor(21); }, 300000);
			}
			else if (obj.ResultCommand == 101) { //AddDeviceMember
				triggerEvent(window.parent.document, 'onWiseAddACDGroupMember', { "result": "success", "message": obj.OKMessage });
			}
			else if (obj.ResultCommand == 112) { //RemoveDeviceMember
				triggerEvent(window.parent.document, 'onWiseDelACDGroupMember', { "result": "success", "message": obj.OKMessage });
			}
		});

		document.addEventListener("onRMCommandFail", function (e) {
			var obj = e.detail;
			//console.log(obj);
			if (obj.ResultCommand == 101) { //AddDeviceMember
				triggerEvent(window.parent.document, 'onWiseAddACDGroupMember', { "result": "fail", "message": obj.ErrMessage });
			}
			else if (obj.ResultCommand == 112) { //RemoveDeviceMember
				triggerEvent(window.parent.document, 'onWiseDelACDGroupMember', { "result": "fail", "message": obj.ErrMessage });
			} else if (obj.ResultCommand == 107) {
				if (parent.wiseMonPopup) {
					parent.wiseMonPopup.close();
				}
				if (parent.wallboardPopup) {
					parent.wallboardPopup.close();
				}

				// alert will run faster then popupclose, and make the window cannot be close because of the alert if no timeout
				setTimeout(function () { alert("Please contact IT support to grant the supervisor rights"); }, 500)
			}
		});

		document.addEventListener("onRMAgentInfo", function (e) {
			var obj = e.detail;
			var i = monAgentList.findIndex(function (v) { return v.agentId == obj.agentId });
			delete obj.Password
			if (i == -1) {
				// monAgentList.push({agentId: obj.agentId, agentName: obj.agentName, agentStatus : obj.agentStatus, ticketList: [], serviceName:obj.serviceName });
				obj.ticketList = [];
				monAgentList.push(obj);
				wsWiseAgent.GetAgentTicketList(obj.agentId);
				i = monAgentList.length - 1;
				//triggerEvent(window.parent.document, 'onMonitorAgentInfo', Object.assign({}, monAgentList[i])); // Some company may no social media service, so get ticket no return
				triggerEvent(window.parent.document, 'onMonitorAgentInfo', { ...monAgentList[i] }); // 20250409 Use an object spread instead of `Object.assign`

				monAgentList[i] = Object.assign(monAgentList[i], obj)
				triggerEvent(window.parent.document, 'onMonitorAgentInfo', monAgentList[i]);
			}
		});

		document.addEventListener("AgentTicketList", function (e) {
			var obj = e.detail;
			var i = monAgentList.findIndex(function (v) { return v.agentId == obj.agent_id });
			if (i != -1) {
				monAgentList[i].ticketList = (obj.ticket_list == null) ? [] : obj.ticket_list.slice(0);				
			  //triggerEvent(window.parent.document, 'onMonitorAgentInfo', Object.assign({}, monAgentList[i])); 
				triggerEvent(window.parent.document, 'onMonitorAgentInfo', { ...monAgentList[i] }); // 20250409 Use an object spread instead of `Object.assign`
				

				//console.log(monAgentList);
			}
		});

		document.addEventListener("AgentTicketStatus", function (e) {
			var obj = e.detail;
			wsWiseAgent.GetAgentTicketList(obj.agent_id);
		});

		document.addEventListener("onRMACDGroupInfo", function (e) {
			var obj = e.detail;
			var i = monACDGroupList.findIndex(function (v) { return v.groupId == obj.groupId });
			if (i == -1) {
				monACDGroupList.push({ "groupId": obj.groupId, "groupName": obj.groupName, "waitCount": obj.waitCount, "waitTime": obj.waitTime });
				i = monACDGroupList.length - 1;
				triggerEvent(window.parent.document, 'onMonitorACDGroupInfo', monACDGroupList[i]);
			} else {
				if (monACDGroupList[i].groupName == "") monACDGroupList[i].groupName = obj.groupName;
				monACDGroupList[i].waitCount = obj.waitCount;
				monACDGroupList[i].waitTime = obj.waitTime;
				triggerEvent(window.parent.document, 'onMonitorACDGroupInfo', monACDGroupList[i]);
			}
		});

		document.addEventListener("onRMCallStatus", function (e) {
			var obj = e.detail;
			var oDeviceHandle = parseInt(obj.oDeviceHandle);
			var dDeviceHandle = parseInt(obj.dDeviceHandle);
			if (obj.statusID == "1") {
				if (oDeviceHandle.toString(16).substr(0, 1) == "6" /*line device*/ && dDeviceHandle.toString(16).substr(0, 1) == "b" /*flow device*/ && !monCallStatusList.includes(obj.callID)) {
					monCallStatusList.push(obj.callID);
					triggerEvent(window.parent.document, 'onMonitorIVRSCount', monCallStatusList.length);
				}
			}
			else if (obj.statusID == "10") {
				if (monCallStatusList.includes(obj.callID)) {
					monCallStatusList.pop(obj.callID);
					triggerEvent(window.parent.document, 'onMonitorIVRSCount', monCallStatusList.length);
				}
			}
		});
		// /wsMonitor End

		window.addEventListener(document, 'wsOnopen', function (e) {
			//console.log("login");
			setTimeout(function () { wsWiseAgent.Login(loginId, loginId, ""); }, 1000);
			//setTimeout(function (){wsWiseAgent.Login(loginId, loginId, "172.17.2.2");},1000);
		});

		addEventListener(document, 'CommandSuccess', function (e) {
			var obj = e.detail;
			var resultCmd = obj.ResultCommand;
			if (resultCmd == 127 || resultCmd == 238) {	// Login & LoginEx
				if (resultCmd == 127) { agentLevelID = obj.LevelID; parent.addWiseMonBtn(); }
				wsWiseAgent.GetACDGroup();
				wsWiseAgent.GetACDPark();
				wsWiseAgent.StartMonitor(1);	//for ACDGroup call queue
				initMediaCount();
				updateQueueTimer = window.setInterval("updateQueueTicker()", 60000, "javascript");
			} else if (resultCmd == 150) { //Unhold
				
				
				if (holdingConnIDs.length > 0) {	// add if to "review this usage of "holdingConnIDs" as it can only be empty here.""
    				holdingConnIDs.pop();
				}
				
				
				var parentholdBtn = parent.$("#icon-line-1")
				parentholdBtn.attr("title", "Hold Call");
				parentholdBtn.find('i').addClass('fa-pause').removeClass('fa-play');
			}
		});

		addEventListener(document, 'CommandFail', function (e) {
			var obj = e.detail;
			//console.log(obj);
			// 108 DialAgent, 213 send message
			if (obj.ResultCommand == 127) {
				alert(obj.Description);
				parent.logoutClicked();
			} else if (obj.ResultCommand == 108) {	//DialAgent
				alert(obj.Description);
			} else if (obj.ResultCommand == 213) {
				sendMsgResult.result = "fail";
				sendMsgResult.data = {};
			} else if (obj.ResultCommand == 219) {
				sendFileResult.result = "fail";
				sendFileResult.data = {};
			} else if (obj.ResultCommand == 150) { //Unhold
				alert('Please try again');
			}
		});

		addEventListener(document, 'AnsCallInfo', function (e) {

			var obj = e.detail;
			//console.log(obj);
			switch (obj.DeviceType) {
				case DEVICE_AGENT:
					caller = " Agent (" + obj.DeviceID + ")";
					break;
				case DEVICE_LINE:
					caller = " Line (" + obj.DeviceID + ")";
					break;
				default:
					caller = "";
			}

			switch (obj.CallType) {
				case CATY_INTER: //Intercom call
					answer = confirm("Accept Intercom Call?" + caller);
					break;
				case CATY_TRANSFER: //Transfer call
					answer = confirm("Accept Transfer Call?" + caller);
					break;
				case CATY_INDB: //inbound call
					answer = confirm("Answer direct call?" + caller);
					break;
				default:
					answer = confirm("Accept Transfer Call?");
			}
			if (answer)
				wsWiseAgent.AcceptCall();
			else {
				wsWiseAgent.RejectCall();
				if (obj.CallType == CATY_INTER)
					wsWiseAgent.SendMessage_UC(3, obj.DeviceID, "@sys-response@intercom-N");
			}
		});

		addEventListener(document, 'AgentStatusEvent', function (e) {
			var obj = e.detail;
			var statusId = obj.StatusID;
			if (statusId != STATUS_HOLD && parent.$("#icon-line-1 i").hasClass('fa-play')) {
				var parentholdBtn = parent.$("#icon-line-1")
				parentholdBtn.attr("title", "Hold Call");
				parentholdBtn.find('i').addClass('fa-pause').removeClass('fa-play');
			}
			window.clearInterval(agentStatusTimer);
			switch (statusId) {
				case STATUS_LOGIN:
					userMode = "LOGIN";

					break;
				case STATUS_IDLE:
					userMode = "IDLE";
					wsWiseAgent.BindToACDGroup(0);
					isMakeConf = false;
					confConnID = 0;
					break;
				case STATUS_WORKING:
					userMode = "WORKING";
					wsWiseAgent.BindToACDGroup(0);
					isMakeConf = false;
					confConnID = 0;
					break;
				case STATUS_HOLD:
					userMode = "HOLD";
					break;
				case STATUS_BREAK:
					userMode = "BREAK";
					break;
				case STATUS_DIALING:
					userMode = "DIALING";
					break;
				case STATUS_READY:
					userMode = "READY";
					break;
				case STATUS_TALKING:
					userMode = "TALK";
					wsWiseAgent.BindToACDGroup(0);
					break;
				case STATUS_PLAYING:
					userMode = "PLAYING";
					break;
				case STATUS_MONITOR:
					userMode = "MONITOR";
					break;
			}
			if (userMode != "") {
				$('#panelAgentStatus').text(userMode);

				$('#panelTimeCount').text("00:00");

				if (userMode == "IDLE") {
					$('#panelAgentStatus').css("color", "red");
				} else if (userMode == "TALK") {
					$('#panelAgentStatus').css("color", "blue");
				} else if (userMode == "HOLD") {
					$('#panelAgentStatus').css("color", "orangered");
				} else {
					$('#panelAgentStatus').css("color", "black");
				}

				try {
					parent.document.getElementById('agent-status-text').innerHTML = userMode;
					parent.document.getElementById('panel-time-count').innerHTML = "00:00";
					parent.$('#panel-agent-status').css('background-color', statusStyle[userMode] || '#6c757d')
					// if(userMode == "IDLE") {
					// 	parent.document.getElementById('panel-agent-status').className = 'nav-link bg-danger dropdown-toggle text-white';// 'nav-link bg-danger';
					// } else if(userMode == "TALK") {
					// 	parent.document.getElementById('panel-agent-status').className = 'nav-link bg-success dropdown-toggle text-white'// 'nav-link bg-success';
					// } else if(userMode == "HOLD") {
					// 	parent.document.getElementById('panel-agent-status').className = 'nav-link bg-warning dropdown-toggle text-white'//'nav-link bg-warning';
					// } else if(userMode == "READY"){
					// 	parent.document.getElementById('panel-agent-status').className = 'nav-link bg-yellow dropdown-toggle text-white';
					// } else {
					// 	parent.document.getElementById('panel-agent-status').className = 'nav-link bg-secondary dropdown-toggle text-white';// 'nav-link bg-secondary';
					// }
				} catch (err) {
					console.log(err.message);
				}

			}
			agentStatusTimer = window.setInterval("agentStatusTicker()", 1000, "javascript");
		});

		var pACDGroup = [];
		addEventListener(document, 'ACDGroupQueueEx', function (e) {
			var obj = e.detail;
			//console.log(obj);
			var bShowQueue = false;
			
			//for (var i = 0; i < obj.Member.length; i++) {//get all member in same GroupID 
			for (let member of obj.Member) { // 20250403 Expected a `for-of` loop instead of a `for` loop with this simple iteration.

				//let member = obj.Member[i];	// 20250403 for loop variable to for-of

				//for (var a = 0; a < serviceList.length; a++) {	
				for (let service of serviceList) {				// 20250403 Expected a `for-of` loop instead of a `for` loop with this simple iteration.

					//let service = serviceList[a];  // 20250403 for loop variable to for-of

					//console.log(serviceList[a]);
					var callType = service.callType;
					//if(callType==CATY_WECHAT || callType==CATY_FBMSG || callType==CATY_FBFAN) callType=CATY_BLOG;
					if (service.acdGroup == member.GroupID && callType == member.CallType) {


						var idx = queueList.findIndex(function (v) { return v.callType == member.CallType && v.acdGroup == member.GroupID });
						/*
						var idx = -1;
						queueList.some(function(v, ii) {
							if (v.callType==obj.Member[i].CallType && v.acdGroup==obj.Member[i].GroupID) {
								idx = ii;
								return true;
							}
						});
						*/
						if (idx == -1) {
							if (member.WaitCount != 0) {
								var q = {
									callType: parseInt(member.CallType), acdGroup: service.acdGroup, entry: service.entry, name: service.name, caption: service.caption,
									dnis: service.dnis, showPriority: service.showPriority, waitTime: member.MaxWaitTime, waitCount: member.WaitCount,
									mediaCount: 0
								};
								//console.log(q);
								queueList.push(q);
								bShowQueue = true;
								if (member.CallType == CATY_BLOG && service.entry == "whatsapp") {
									openAlert(member.CallType, "New Whatsapp user. Please answer the chat.", member.WaitCount, member.MaxWaitTime);
									/*
									if(queAudio.currentTime==0 || queAudio.currentTime==queAudio.duration || queAudio.paused || queAudio.ended) {
										queAudio.currentTime=0;
										queAudio.play();
									}
									*/
								}
							}
							else {
								var alert_idx = originalMsgArr.findIndex(function (el) { return el.callType == member.CallType; });
								if (alert_idx != -1) originalMsgArr.splice(alert_idx, 1);
								// console.log(originalMsgArr);
								if (originalMsgArr.length == 0 && popup != null) popup.close();
							}
						} else if (idx >= 0) {
							//console.log(queueList[idx]);
							if (queueList[idx].mediaCount == 0 && member.WaitCount == 0) {
								var alert_idx = originalMsgArr.findIndex(function (el) { return el.callType == member.CallType; });
								if (alert_idx != -1) originalMsgArr.splice(alert_idx, 1);
								console.log(originalMsgArr);
								if (originalMsgArr.length == 0 && popup != null) popup.close();

								queueList.splice(idx, 1);
								bShowQueue = true;
							}
							else {



								if (queueList[idx].waitTime != member.MaxWaitTime || queueList[idx].waitCount != member.WaitCount) bShowQueue = true;
								queueList[idx].waitTime = member.MaxWaitTime;
								queueList[idx].waitCount = member.WaitCount;

								var bShowAlert = false;

								if (pACDGroup.length == 0)
									bShowAlert = true;
								else {
									var p = pACDGroup.findIndex(function (v) { return v.CallType == member.CallType && v.GroupID == member.GroupID });
									
									/* // 20250410  'If' statement should not be the only statement in 'else' block
									if (p == -1)
										bShowAlert = true;
									else {
										if (member.WaitCount > pACDGroup[p].WaitCount)
											bShowAlert = true;
										else if (member.WaitCount == pACDGroup[p].WaitCount) {
											if (member.MaxWaitTime < pACDGroup[p].MaxWaitTime) bShowAlert = true;
										}
									}*/

									if ((p == -1) || 
										(member.WaitCount > pACDGroup[p].WaitCount) ||
										((member.WaitCount == pACDGroup[p].WaitCount) && (member.MaxWaitTime < pACDGroup[p].MaxWaitTime))
									   )
									{
										bShowAlert = true;
									}

								}

								if (bShowAlert) {
									if (member.CallType == CATY_BLOG && service.entry == "whatsapp")
										openAlert(member.CallType, "New Whatsapp user. Please answer the chat.", member.WaitCount, member.MaxWaitTime);
								}
							}
							/*
							if(obj.Member[i].WaitCount!=0) {
								queueList[idx].waitTime = obj.Member[i].MaxWaitTime;
								queueList[idx].waitCount = obj.Member[i].WaitCount;
							} else if(queueList[idx].mediaCount==0) queueList.splice(idx,1);
							*/
						}
					}
				}
			}
			//console.log(bShowQueue);
			if (bShowQueue) {
				queueList.sort(function (a, b) { var e = a.showPriority - b.showPriority; if (e == 0) return (b.waitTime - a.waitTime); else return e; });
				showQueueList();
			}
		});

		addEventListener(document, 'CallMessage', function (e) {//Object got: {obj.Member[i].VarType, obj.Member[i].VarMsg}
			var obj = e.detail;
			//console.log(obj);
			mediaFrom = "";
			mediaTo = "";
			mediaSubject = "";
			mediaID = 0;
			//for (var i = 0; i < obj.Member.length; i++) {		// 20250414 add Add the "let", "const" or "var" keyword to this declaration of "i" to make it explicit.
			for (let member of obj.Member) {					// 20250414 Expected a for-of loop instead of a for loop with this simple iteration. update obj.Member[i] to member 
				switch (obj.Member[i].VarType) {
					case C_VAL_DATA:
						ivrsMessage = member.VarMsg;
						break;
					case C_VAL_CONNECTIONID:
						connID = member.VarMsg;
						if (callType == CATY_CONF) confConnID = connID;
						break;
					case C_VAL_CALLID:
						callID = member.VarMsg;
						//if (callType==CATY_OUTBD && ANINo=="") return;
						break;
					case C_VAL_SERVICEID:
						serviceID = member.VarMsg;
						break;
					case C_VAL_CALLTYPE:
						callType = member.VarMsg;
						break;
					case C_VAL_ANI:
						ANINo = member.VarMsg;
						//currCallInfo.lastCallType =callType;

						break;
					case C_VAL_DNIS:
						DNISNo = member.VarMsg;

						break;
					case C_VAL_ATTACHMENT:
						attachment = member.VarMsg;
						break;
					case C_VAL_MEDIAFROM:
						mediaFrom = member.VarMsg;
						break;
					case C_VAL_MEDIATO:
						mediaTo = member.VarMsg;
						break;
					case C_VAL_MEDIASUBJECT:
						mediaSubject = member.VarMsg;
						break;
					case C_VAL_MEDIAID:				
						mediaID = member.VarMsg;
						break;
			//		case C_VAL_ATTACHMENT:			// 20250408 if/else if" chains and "switch" cases should not have the same condition
			//			attachment = obj.Member[i].VarMsg;
			//			break;
			//		case C_VAL_MEDIATO:
			//			mediaTo = obj.Member[i].VarMsg;
			//			break;
			//		case C_VAL_MEDIAFROM:			
			//			mediaFrom = obj.Member[i].VarMsg;
			//			break;
			//		case C_VAL_MEDIASUBJECT:
			//			mediaSubject = obj.Member[i].VarMsg;
			//			break;

				}
			}
			$("#softPhone").css("cursor", "default");
			$("#queueListBar").find("[id*='QueueCount1']").css("cursor", "pointer");
			if (callType == CATY_OUTBD || callType == CATY_INDB || callType == CATY_INTER) {
				currconnID = connID;
				var i = onlineConnIDs.findIndex(function (v) { return v.connID == connID; });
				if (i == -1) onlineConnIDs.push({ "connID": parseInt(connID), "callType": callType, "ANINo": ANINo, "DNISNo": DNISNo, "holding": 0 });
			}
			else if (callType == CATY_CONF) {
				confConnID = connID;
			}
			else if (callType == CATY_TRANSFER) { //trsnagfer from agent when serviceID is zero. Otherwise, transfer from IVRS when serviceID is not zero.
				if (serviceID != 0) {
					currconnID = connID;
					var i = onlineConnIDs.findIndex(function (v) { return v.connID == connID; });
					if (i == -1) onlineConnIDs.push({ "connID": parseInt(connID), "callType": callType, "ANINo": ANINo, "DNISNo": DNISNo, "holding": 0 });
				}
			}

			if (callType == CATY_OUTBD || callType == CATY_INDB || callType == CATY_TRANSFER || callType == CATY_CONF) {

				if (callType == CATY_CONF && isMakeConf) {	//when agent create conference call
					currCallInfo.confCallID = callID;
					// call UI
					window.parent.replyCallClick(currCallInfo.lastCallType, currCallInfo.lastCallID, currCallInfo.confConnID);
				} else if (callType == CATY_OUTBD) {
					// call UI
					//console.log(callID);
					if (currCallInfo.lastCallID != callID) {
						currCallInfo.lastCallType = callType;
						currCallInfo.lastCallID = callID;
						var c = { "callType": callType, "callID": callID, "ANI": ANINo, "DNIS": DNISNo, "Message": ivrsMessage };
						if (currCallInfo.callSeq.filter(function (v) { return v.callID == c.callID }).length == 0)
							currCallInfo.callSeq.push(c);
						//console.log(currCallInfo);

						window.parent.replyCallClick(callType, callID, 0);
					}
				} else {
					currCallInfo.lastCallType = callType;
					currCallInfo.lastCallID = callID;
					var c = { "callType": callType, "callID": callID, "ANI": ANINo, "DNIS": DNISNo, "Message": ivrsMessage };
					if (currCallInfo.callSeq.filter(function (v) { return v.callID == c.callID }).length == 0)
						currCallInfo.callSeq.push(c);
					//console.log(currCallInfo);

					//all type of inbounds: inbound call , transfer in call, agent invite in conference call
					if (callType == CATY_INDB || callType == CATY_TRANSFER || (callType == CATY_CONF && !isMakeConf)) {
						//var s = serviceList.filter(function (v) { return v.callType==callType && v.dnis==DNISNo });
						var s = serviceList.filter(function (v) { return v.callType == CATY_INDB && v.dnis == DNISNo });
						if (s.length > 0)
							window.parent.connClick(callID, s[0].name, channels[CATY_INDB], ANINo, DNISNo, ivrsMessage);
					}
				}
			} else if ((callType == CATY_EMAIL || callType == CATY_VMAIL) && mediaFrom != "") {
				//console.log(mediaFrom);
				updateMediaCount(callType, mediaFrom, 10);
				/*
				try {
					var s = serviceList.filter(function (v) { return v.callType==callType && v.dnis.toLowerCase()==mediaFrom.toLowerCase() });
					//console.log(s);
					if(s.length==0) return;

					window.parent.connClick(callID,s[0].name,channels[callType],mediaFrom,null);
				} catch(err) {
					console.log(err.message);
				}
				*/
			} else if (callType == CATY_FAX) {
				//console.log(DNISNo);
				try {
					var s = serviceList.filter(function (v) { return v.callType == callType && v.dnis == DNISNo });
					if (s.length == 0) return;
					window.parent.connClick(callID, s[0].name, channels[callType], ANINo, DNISNo, "");
				} catch (err) {
					console.log(err.message);
				}
			} else if ((callType == CATY_BLOG || callType == CATY_WEBCHAT) && mediaID != 0) {
				//window.parent.connClick(connID,s[0].name,channels[callType],mediaFrom,mediaID,null);
				//console.log(mediaID);
				//ticketList.push({ticketId: mediaID, ticketStatus: "open", onlineForm: [], offlineForm: [], msgList:[]});
				//ticketList.push({ticketId: mediaID, ticketStatus: "open"});
				if (mediaSubject == 'webchat_offlineForm') {
					// triggerEvent(document, "OfflineForm", {obj});
					triggerEvent(document, "OfflineForm", { 'Command': obj.Command, 'company_code': mediaFrom, 'ticket_id': mediaID, entry: "webchat", "offline_form": 1 });
					wsWiseAgent.GetOfflineForm(mediaID);
					wsWiseAgent.UpdateTicket(mediaID, loginId);
				} else {
					var s = serviceList.filter(function (v) { return v.callType == callType && v.dnis == DNISNo });
					if (s.length != 0) {
						var rCalltype = callType;
						if (callType == CATY_BLOG && s[0].entry == "wechat") rCalltype = CATY_WECHAT;
						else if (callType == CATY_BLOG && s[0].entry == "whatsapp") rCalltype = CATY_WHATSAPP;
						else if (callType == CATY_BLOG && s[0].entry == "fbmsg") rCalltype = CATY_FBMSG;
						else if (callType == CATY_BLOG && s[0].entry == "fbpost") rCalltype = CATY_FBPOST;
						var i = mediaCallMessage.findIndex(function (v) { return v.call_id == callID; });
						if (i == -1) {
							mediaCallMessage.push({ "call_id": callID, "ticket_id": mediaID });
						}
						//Tiger 2020-6-2
						window.parent.connClick(callID, s[0].name, channels[rCalltype], mediaTo, DNISNo, mediaID);
					}
					wsWiseAgent.UpdateTicket(mediaID, loginId);
				}
				//wsWiseAgent.GetOfflineForm(mediaID);
				//wsWiseAgent.UpdateTicket(TicketNo,loginId);
				//wsWiseAgent.GetOnlineForm(mediaID);
			}
		});

		addEventListener(document, 'CallStatusEvent', function (e) {
			var obj = e.detail;
			console.log(obj);
			var i = -1;
			switch (obj.StatusID) {
				case CALL_ESTAB:
					i = onlineConnIDs.findIndex(function (v) { return v.connID == obj.ConnID; });
					if (i != -1) onlineConnIDs[i].holding = 0;
					break;
				case CALL_ESTHOLD:
				case CALL_ESTDHOLD:
					console.log("currconnID=" + currconnID);
					console.log(onlineConnIDs);

					i = onlineConnIDs.findIndex(function (v) { return v.connID == obj.ConnID; });
					console.log("i=" + i);
					if (i != -1) onlineConnIDs[i].holding = 1;

					i = onlineConnIDs.findIndex(function (v) { return v.connID != obj.ConnID; });
					console.log("i=" + i);
					if (i != -1) {
						currconnID = parseInt(onlineConnIDs[i].connID);
						console.log("currconnID=" + currconnID);
						setTimeout(function () { wsWiseAgent.Unhold(currconnID); }, 2000);
					}
					//holdingConnIDs.push(connID);
					break;
				case CALL_END:
					//case CALL_FINISH:
					//case CALL_TERMINATE:
					console.log(onlineConnIDs);
					i = onlineConnIDs.findIndex(function (v) { return v.connID == obj.ConnID });
					if (i != -1) onlineConnIDs.splice(i, 1);

					i = onlineConnIDs.findIndex(function (v) { return v.connID != obj.ConnID });
					if (i != -1) {
						currconnID = parseInt(onlineConnIDs[i].connID);


					}
					isMakeConf = false;
					confConnID = 0;
					/*
					console.log(holdingConnIDs);
					var i=holdingConnIDs.findIndex(function(v){return v.connID==obj.connID });
					if(i!=-1) holdingConnIDs.splice(i,1);

					var x=holdingConnIDs.findIndex(function(v){return v.connID!=obj.connID });
					if(x!=-1) currconnID=parseInt(x.connID);
					*/
					try {
						window.parent.callEndClick(obj.ConnID);
					} catch (err) {
						console.log(err.message);
					}
					break;
			}
		});

		addEventListener(document, 'MediaCallStatus', function (e) {//Object got: {obj.ConnID, obj.CallType, obj.StatusID}
			var obj = e.detail;
			if (obj.ConnID != 0) {
				if (obj.StatusID == CALL_I_QUEUE) {			//New Queue
				}
			}
		});

		addEventListener(document, 'StartScreenCap', function (e) {
			var obj = e.detail;
			// need to have DDE like BOCPT
		});

		addEventListener(document, 'StopScreenCap', function (e) {
			var obj = e.detail;
			// need to have DDE like BOCPT
		});

		addEventListener(document, 'OfflineForm', function (e) {
			var obj = e.detail;
			var idx = ticketList.findIndex(function (v) { return v.ticket_id == obj.ticket_id });
			// if (idx==-1) return;
			if (idx == -1) {  // to create a form with company name first
				var ticket = jQuery.extend({}, obj);
				ticket.online_form_data = [];
				ticket.offline_form_data = [];
				ticket.ticket_status = "open";
				ticket.company_name = "";
				ticket.company_short_name = "";
				var s = serviceList.filter(function (v) { return v.callType == CATY_WEBCHAT && v.dnis == ticket.company_code })[0];
				if (s != undefined) { ticket.company_name = s.name; ticket.company_short_name = s.shortName; }
				ticketList.push(ticket);
				/*
				currSocialMsg = jQuery.extend({}, obj);
				currSocialMsg.online_form_data=[];
				currSocialMsg.offline_form_data=[];
				*/
				// triggerEvent(window.parent.document, 'onWiseSocialMsg', ticket);
			} else { // by ticket id match, return offline_form_data
				//var bEvent = (ticketList[idx].offline_form_data.length == 0) ? true : false;  // 20250320 Unnecessary use of boolean literals in conditional expression.
				var bEvent = (ticketList[idx].offline_form_data.length == 0);
				if (bEvent) {
					ticketList[idx].offline_form = 1;
					if (obj.data) { ticketList[idx].offline_form_data = obj.data; }
					//currSocialMsg.offline_form_data = obj.data;
					//console.log('ticketList[idx]');console.log(ticketList[idx]);
					ticketList[idx].start_time = "";
					$.ajax({
						type: "POST",
						url: config.wiseHost + "/WisePBX/api/SocialMedia/GetFormData",
						data: JSON.stringify({ "ticketId": obj.ticket_id }),
						contentType: "application/json; charset=utf-8",
						dataType: "json",
						success: function (r) {
							if (r.result == "success") {
								ticketList[idx].start_time = r.data.start_time;
							}
							triggerEvent(window.parent.document, 'onWiseSocialMsg', ticketList[idx]);
							if (gettingOnlineTicket[obj.ticket_id]) {
								delete gettingOnlineTicket[obj.ticket_id];
							}
						},
						error: function (r) {
							console.log(r);
							triggerEvent(window.parent.document, 'onWiseSocialMsg', ticketList[idx]);
							if (gettingOnlineTicket[obj.ticket_id]) {
								delete gettingOnlineTicket[obj.ticket_id];
							}
						},
					});
				}

			}
		});

		addEventListener(document, 'OnlineForm', function (e) {
			var obj = e.detail;
			//console.log(obj);
			//console.log(ticketList);
			/*
			var idx = -1;
			ticketList.some(function(v, i) {
				if (v.ticketId==obj.ticket_id) {
					idx = i;
					return true;
				}
			});
			*/
			var idx = ticketList.findIndex(function (v) { return v.ticket_id == obj.ticket_id });
			//console.log(idx);
			if (idx == -1) return;
			//console.log(ticketList[idx]);

			//var bEvent = (ticketList[idx].online_form_data.length == 0) ? true : false;	//20250320 Unnecessary use of boolean literals in conditional expression.
			var bEvent = (ticketList[idx].online_form_data.length == 0);
			ticketList[idx].online_form = 1;
			ticketList[idx].online_form_data = obj.data;
			//console.log(currSocialMsg);
			//currSocialMsg.online_form_data = obj.data;
			if (bEvent && ticketList[idx].msg_list != undefined) triggerEvent(window.parent.document, 'onWiseSocialMsg', ticketList[idx]);
			if (gettingOnlineTicket[obj.ticket_id]) {
				delete gettingOnlineTicket[obj.ticket_id];
			}
		});

		addEventListener(document, 'SendSocialMsgToAgent', function (e) {
			var obj = e.detail;
			//console.log(obj);
			/*
			var idx = -1;
			ticketList.some(function(v, i) {
				if (v.ticketId==obj.ticket_id) {
					idx = i;
					return true;
				}
			});
			*/
			var idx = ticketList.findIndex(function (v) { return v.ticket_id == obj.ticket_id });
			//console.log(idx);
			if (idx == -1) {
				var ticket = jQuery.extend({}, obj);
				ticket.online_form_data = [];
				ticket.offline_form_data = [];
				ticket.ticket_status = "open";
				ticket.company_name = "";
				ticket.company_short_name = "";
				if (ticket.entry == "webchat") {
					var s = serviceList.filter(function (v) { return v.callType == CATY_WEBCHAT && v.dnis == ticket.company_code })[0];
					if (s != undefined) { ticket.company_name = s.name; ticket.company_short_name = s.shortName; }
				} else {
					var s = serviceList.filter(function (v) { return v.callType == CATY_BLOG && v.dnis == ticket.company_code })[0];
					if (s != undefined) { ticket.company_name = s.name; ticket.company_short_name = s.shortName; }
				}
				var m = mediaCallMessage.filter(function (v) { return v.ticket_id == obj.ticket_id })[0];
				ticket.conn_id = (m != undefined) ? m.call_id : 0;
				ticketList.push(ticket);

				/*
				currSocialMsg = jQuery.extend({}, obj);
				currSocialMsg.online_form_data=[];
				currSocialMsg.offline_form_data=[];
				*/
				if (ticket.entry == "webchat") {
					if (obj.offline_form == 0) {
						wsWiseAgent.GetOnlineForm(obj.ticket_id);
						gettingOnlineTicket[obj.ticket_id] = true;
					} else {
						wsWiseAgent.GetOfflineForm(obj.ticket_id);
						gettingOnlineTicket[obj.ticket_id] = true;
					}
				}
				else {
					triggerEvent(window.parent.document, 'onWiseSocialMsg', ticket);
				}
		//	} else { 	//	20250410 'If' statement should not be the only statement in 'else' block
				//ticketList[idx].msgList.concat(obj.msg_list);

				/*
				currSocialMsg = jQuery.extend({}, obj);
				currSocialMsg.online_form_data = ticketList[idx].onlineForm;
				currSocialMsg.offline_form_data = ticketList[idx].offlineForm;
				currSocialMsg.ticket_status = ticketList[idx].ticketStatus;
				*/
			} else if (obj.msg_list != undefined && ticketList[idx].ticketStatus != "end" && ticketList[idx].ticketStatus != "timeout") {
					if (gettingOnlineTicket[obj.ticket_id]) {
						if (Array.isArray(ticketList[idx].msg_list)) {
							ticketList[idx].msg_list = ticketList[idx].msg_list.concat(obj.msg_list);
						} else {
							ticketList[idx].msg_list = obj.msg_list;
						}
					} else {
						ticketList[idx].Command = obj.Command;
						ticketList[idx].msg_list = obj.msg_list;
						triggerEvent(window.parent.document, 'onWiseSocialMsg', ticketList[idx]);
					}
					console.log("winOnFocus=" + winOnFocus);
					//if (winOnFocus == false) {	// 20250407 Refactor the code to avoid using this boolean literal.
					if (!winOnFocus) {
						if (obj.msg_list[0].sender == "enduser" && (ticketList[idx].entry == "webchat" || ticketList[idx].entry == "facebook" || ticketList[idx].entry == "whatsapp")) {
							if (msgAudio.currentTime == 0 || msgAudio.currentTime == msgAudio.duration || msgAudio.paused || msgAudio.ended) {
								msgAudio.currentTime = 0;
								msgAudio.play();
							}
						}
					}
					//console.log('obj');
					//console.log(obj);
					//console.log('ticketList[idx]');
					//console.log(ticketList[idx]);
				//} 20250410 if and else
			}
			//console.log(currSocialMsg);
		});

		addEventListener(document, 'TicketMsgList', function (e) {
			var obj = e.detail;
			//console.log(obj.ticket_id);
			/*
			var idx = -1;
			ticketList.some(function(v, i) {
				if (v.ticketId==obj.ticket_id) {
					idx = i;
					return true;
				}
			});
			*/
			//var idx = ticketList.findIndex(function (v) { return v.ticket_id==obj.ticket_id});
			//if (idx==-1) return;
			// obj.data.msg_list=JSON.parse(JSON.stringify(obj.data.msg_list).split('"sent_by_flag":').join('"send_by_flag":'));
			obj.start_time = "";
			obj.online_form = 0;
			obj.online_form_data = [];
			obj.offline_form = 0;
			obj.offline_form_data = [];
			$.ajax({
				type: "POST",
				url: config.wiseHost + "/WisePBX/api/SocialMedia/GetFormData",
				data: JSON.stringify({ "ticketId": obj.ticket_id }),
				contentType: "application/json; charset=utf-8",
				dataType: "json",
				success: function (r) {
					if (r.result == "success") {
						obj.start_time = r.data.start_time;
						if (r.data.online.length > 0) {
							obj.online_form = 1;
							obj.online_form_data = r.data.online;
						}

						if (r.data.offline.length > 0) {
							obj.offline_form = 1;
							obj.offline_form_data = r.data.offline;
						}
					}
					//console.log(obj);
					triggerEvent(window.parent.document, 'onWiseSocialMsgList', obj);
				},
				error: function (r) {
					console.log(r);
					triggerEvent(window.parent.document, 'onWiseSocialMsgList', obj);
				},
			});



			/*
			var msgList = jQuery.extend({}, obj);
			msgList.online_form_data = ticketList[idx].onlineForm;
			msgList.offline_form_data = ticketList[idx].offlineForm;
			msgList.ticket_status = ticketList[idx].ticketStatus;
			triggerEvent(document, 'onWiseSocialMsg', msgList);
			*/


		});

		addEventListener(document, 'EndTicket', function (e) {
			var obj = e.detail;
			//console.log(obj);
			/*
			var idx = -1;
			ticketList.some(function(v, i) {
				if (v.ticketId==obj.ticket_id) {
					idx = i;
					return true;
				}
			});
			*/
			var idx = ticketList.findIndex(function (v) { return v.ticket_id == obj.ticket_id });
			if (idx == -1) return;
			ticketList[idx].ticketStatus = "end";
			if (ticketList[idx].offline_form != 1) {
				triggerEvent(window.parent.document, 'onWiseSocialStatus', { ticket_id: obj.ticket_id, ticket_status: "end" });
			}
		});

		addEventListener(document, 'WCCustomerInput', function (e) {
			triggerEvent(window.parent.document, 'onWCCustomerInput', e.detail.ticket_id);
		});

		addEventListener(document, 'TicketTimeout', function (e) {
			var obj = e.detail;
			//console.log(obj);
			/*
			var idx = -1;
			ticketList.some(function(v, i) {
				if (v.ticketId==obj.ticket_id) {
					idx = i;
					return true;
				}
			});
			*/
			var idx = ticketList.findIndex(function (v) { return v.ticket_id == obj.ticket_id });
			if (idx == -1) return;
			ticketList[idx].ticketStatus = "timeout";
			if (ticketList[idx].offline_form != 1) {
				triggerEvent(window.parent.document, 'onWiseSocialStatus', { ticket_id: obj.ticket_id, ticket_status: "timeout" });
			}
		});

		addEventListener(document, 'ResultSendMsg', function (e) {
			var obj = e.detail;
			//console.log(obj);
			//sendMsgResult.result = (obj.data.client_msg_id!="" && obj.data.id!="") ? "success" : "fail";
			//if (sendMsgResult.result=="success") sendMsgResult.data=obj.data;
			sendMsgResult.result = "success";
			sendMsgResult.data = obj.data;
		});

		addEventListener(document, 'ResultSendFile', function (e) {
			var obj = e.detail;
			//console.log(obj);
			sendFileResult.result = (obj.data.client_msg_id != "" && obj.data.id != "") ? "success" : "fail";
			// if (sendFileResult.result=="success") sendFileResult.data=obj.data;
			// sendFileResult.result = "success";
			sendFileResult.data = obj.data;
		});

		// var postTicketId=0;
		addEventListener(document, 'FaceBookPost', function (e) {
			var obj = e.detail;
			// if(postTicketId!=obj.ticket_id)
			// {
			triggerEvent(window.parent.document, 'onWiseFBPost', { ticket_id: obj.ticket_id, message: obj.message });
			// postTicketId=obj.ticket_id;
			// }
			// console.log(obj);
		});

		addEventListener(document, 'SameLevelReply', function (e) {
			var obj = e.detail;
			//console.log(obj);
		});

		addEventListener(document, 'RecvInvAgentToChat', function (e) {
			var obj = e.detail;
			//console.log(obj);
			triggerEvent(window.parent.document, 'onWiseRecvInvAgentToChat', obj);
		});
		// when agent got message from invited agent
		addEventListener(document, 'RecvShortMsg_UC', function (e) {
			var obj = e.detail;
			//console.log(obj);
			var msg = obj.ShortMsg;
			if (msg == "@sys-response@intercom-N") {
				alert("Agent rejected to answer intercom call.");
			}
			else
				triggerEvent(window.parent.document, 'onWiseRecvShortMsg_UC', obj);
		});
		// when agent be invited to a conference
		addEventListener(document, 'ClientMsgID', function (e) {
			var obj = e.detail;
			//console.log(obj);
			triggerEvent(window.parent.document, 'onWiseClientMsgID', obj);
		});

		addEventListener(document, 'ACDGroupInfo', function (e) {
			var obj = e.detail;
			console.log(obj);
			triggerEvent(window.parent.document, 'onWiseACDGroupInfo', obj);
		});

		addEventListener(document, 'ACDGroupMember', function (e) {
			var obj = e.detail;
			
			//for (var i = 0; i < obj.Member.length; i++) {				//20250414 Add the "let", "const" or "var" keyword to this declaration of "i" to make it explicit.
			//	obj.Member[i].Status = agentStatus[obj.Member[i].StatusID];
			//}
			
			for (let member of obj.Member)					//20250414 Expected a `for-of` loop instead of a `for` loop with this simple iteration.
				member.Status = agentStatus[member.StatusID];
			}
			
			
			//console.log(obj);
			if (acdGroupMemberBy == "WiseGetAgentList")
				triggerEvent(window.parent.document, 'onWiseAgentList', obj);
			else
				triggerEvent(window.parent.document, 'onWiseACDGroupMember', obj);
			acdGroupMemberBy = "";
		});

		addEventListener(document, 'LogonAgentEx ', function (e) {
			var obj = e.detail;
			obj.Member = obj.Agentlist.slice();
			console.log(obj.Member);
			var objMember = obj.Member;
			//for (var i = 0; i < objMember.length; i++) {				//20250414 Add the "let", "const" or "var" keyword to this declaration of "i" to make it explicit.
			for (let theMember of objMember)							//20250414 Expected a `for-of` loop instead of a `for` loop with this simple iteration.
				//var theMember = objMember[i];
				theMember.Status = agentStatus[theMember.StatusID];
				// NO DEL, please define agentStatusBreak object if needed
				// if(obj.Member[i].StatusID==STATUS_BREAK){
				// 	theMember.Status=agentStatusBreak[theMember.subStatusID];
				// } else { theMember.Status=agentStatus[theMember.StatusID]; }
				// /NO DEL
			}
			currentAgentList = obj.Member;

			triggerEvent(window.parent.document, 'onWiseAgentList', obj);
		});

		addEventListener(document, 'WCCustomerParameter', function (e) {
			var obj = e.detail;
			// var idx = ticketList.findIndex(function (v) { return v.ticket_id==obj.ticket_id});
			// if (idx==-1) return;
			// ticketList[idx].last_ticket=obj.last_ticket; // NO DEL, no need for now
			// ticketList[idx].parameter=1; // NO DEL, no need for now
			// ticketList[idx].companyName=obj.companyName||''; // NO DEL, no need for now
			// ticketList[idx].lang=obj.lang||''; // NO DEL, no need for now
			// ticketList[idx].source=obj.source||''; // NO DEL, no need for now
			// ticketList[idx].qrcode=obj.qrcode||''; // NO DEL, no need for now
			// ticketList[idx].location=obj.location||''; // NO DEL, no need for now
			// ticketList[idx].browser=obj.brower_user_agent||''; // NO DEL, no need for now
			// ticketList[idx].msg_list=[]; // NO DEL, no need for now
			// if(ticketList[idx].online_form==1 || ticketList[idx].offline_form==1) {
			triggerEvent(window.parent.document, 'addAdditionalInfo', obj);
			// }
		});

		addEventListener(document, 'WCCustomerReadMsg', function (e) {
			var obj = e.detail;
			triggerEvent(window.parent.document, 'onWiseReadMsg', obj);
		});

		addEventListener(document, 'SendTemplateMsg', function (e) {
			var obj = e.detail;
			if (jQuery.isEmptyObject(templateMsgResult)) {
				templateMsgResult = jQuery.extend({}, obj);
			} else {
				templateMsgResult.resultID = obj.resultID
				templateMsgResult.msg = obj.msg;
			}
			templateMsgResultEx.push(obj.ticket_id);
		});

		addEventListener(document, 'AddAgentCallQueue', function (e) {
			var obj = e.detail;
			//console.log(obj);
			directCalls.push(obj.ConnID);
			window.parent.$("#panel-direct-count").css("background", "blue");
			window.parent.$("#direct-count-text").text("Queue: " + String(directCalls.length));
		});

		addEventListener(document, 'RemoveAgentCallQueue', function (e) {
			var obj = e.detail;
			//console.log(obj);
			directCalls = directCalls.filter(function (e) {
				return e != obj.ConnID;
			});
			if (directCalls.length == 0)
				window.parent.$("#panel-direct-count").css("background", "");
			else
				window.parent.$("#panel-direct-count").css("background", "blue");
			window.parent.$("#direct-count-text").text("Queue: " + String(directCalls.length));
			//console.log(directCalls);
		});

		function EncodeTime(t) {

			var s = "0" + t % 60;
			var m = "" + parseInt(t / 60);
			if (m.length == 1) m = "0" + m;
			//else if ( m.length>3) m="+999";

			return m + ":" + s.slice(-2);
		}

		function Sound(source, volume, loop) {
			this.source = source;
			this.volume = volume;
			this.loop = loop;
			var son;
			this.son = son;
			this.finish = false;
			this.stop = function () {
				document.body.removeChild(this.son);
			}
			this.start = function () {
				if (this.finish) return false;
				this.son = document.createElement("embed");
				this.son.setAttribute("src", this.source);
				this.son.setAttribute("hidden", "true");
				this.son.setAttribute("volume", this.volume);
				this.son.setAttribute("autostart", "true");
				this.son.setAttribute("loop", this.loop);
				this.son.setAttribute("enablejavascript", "true");
				document.body.appendChild(this.son);
			}
			this.remove = function () {
				if (this.son == undefined) return;
				document.body.removeChild(this.son);
				this.finish = true;
			}
			this.init = function (volume, loop) {
				this.finish = false;
				this.volume = volume;
				this.loop = loop;
			}
		}

		var oldStatus = "";
		function agentStatusTicker() {
			//if (userMode != oldStatus && userMode != "WRAP UP" && userMode != "HOLD" || (userMode == "TALK" && userMode == "READY")) {
			if (userMode != oldStatus) {
				oldStatus = userMode;
				// document.getElementById('panelTimeCount').innerHTML="00:00";
				document.getElementById('panelTimeCount').innerHTML = "00:01";
				try {
					// parent.document.getElementById('panel-time-count').innerHTML="00:00";
					parent.document.getElementById('panel-time-count').innerHTML = "00:01";
				} catch (err) {
					console.log(err.message);
				}
			}
			else {
				var s = document.getElementById('panelTimeCount').innerHTML.split(":");		//20250414 Add the "let", "const" or "var" keyword to this declaration of "s"/"t" to make it explicit.
				var t = parseInt(s[0]) * 60 + parseInt(s[1]) + 1;
				document.getElementById('panelTimeCount').innerHTML = EncodeTime(t);

				try {
					s = parent.document.getElementById('panel-time-count').innerHTML.split(":");
					t = parseInt(s[0]) * 60 + parseInt(s[1]) + 1;
					parent.document.getElementById('panel-time-count').innerHTML = EncodeTime(t);
				} catch (err) {
					console.log(err.message);
				}
			}
		}

		function updateQueueTicker() {
			window.clearInterval(updateQueueTimer);
			/*
			for(i=0;i<queueList.length;i++) {
				if ( queueList[i].callType== CATY_EMAIL || queueList[i].callType==CATY_VMAIL || queueList[i].callType==CATY_FAX) {
					updateMediaCount(queueList[i].callType,queueList[i].dnis);
				}
			}
			*/
			var updateFlag = false;
			//for (var i = 0; i < serviceList.length; i++) {			//20250414 Add the "let", "const" or "var" keyword to this declaration of "i" to make it explicit.
			for (const service of serviceList) { 					//20250414 Use `for-of` to iterate over the array // update serviceList[i] to service
				if (service.callType == CATY_EMAIL || service.callType == CATY_VMAIL || service.callType == CATY_FAX) {
					if (queueList.filter(function (v) { return v.callType == service.callType && v.dnis == service.dnis }).length == 0) {
						var link = "";
						if (service.callType == CATY_EMAIL)
							link = config.wiseHost + "/WisePBX/api/Email/GetCount";
						else if (service.callType == CATY_VMAIL)
							link = config.wiseHost + "/WisePBX/api/Vmail/GetCount";
						else if (service.callType == CATY_FAX)
							link = config.wiseHost + "/WisePBX/api/Fax/GetCount";
						if (link != "") {
							//console.log(link);
							$.ajax({
								type: "POST",
								async: true,
								url: link,
								data: JSON.stringify({ "dnis": service.dnis, "agentId": loginId }),
								contentType: "application/json; charset=utf-8",
								dataType: "json",
								service: service,
								success: function (r) {
									var mediaCount = r.data;
									//console.log(this.service);
									if (mediaCount > 0) {
										var q = {
											callType: this.service.callType, acdGroup: this.service.acdGroup, name: this.service.name, caption: this.service.caption,
											dnis: this.service.dnis, showPriority: this.service.showPriority, waitTime: 0, waitCount: 0,
											mediaCount: mediaCount
										};
										queueList.push(q);
										queueList.sort(function (a, b) { var e = a.showPriority - b.showPriority; if (e == 0) return (b.waitTime - a.waitTime); else return e; });
										showQueueList();
									}
								},
								error: function (r) {
									console.log(r);
								}
							});
						}
					}
				}
			}
			/*
			if (updateFlag) {
				queueList.sort(function (a,b) { var e =a.showPriority -b.showPriority; if(e==0) return (b.waitTime-a.waitTime); else return e; });
				showQueueList();
			}
			*/
			//initMediaCount();
			updateQueueTimer = window.setInterval("updateQueueTicker()", 60000, "javascript");
		}

		function inboundQueueTicker() {
			// return;
			var isQueue = false;
		  //for (var a = 0; a < serviceList.length; a++) {
			for (let service of serviceList) {				// 20250403 Expected a `for-of` loop instead of a `for` loop with this simple iteration.

			   	//let service = serviceList[a];				// 20250403	Expected a `for-of` loop instead of a `for` loop with this simple iteration.

				//alert($("#inboundQueue_"+serviceList[a].name).text());
				if ($("#inboundQueue_" + service.name).text() != "0" && $("#inboundQueue_" + service.name).text() != "") {
					$("#inboundQueue_" + service.name).fadeIn(250).fadeOut(250).fadeIn(250);
					//console.log(serviceList[a]);
					isQueue = true;
				} else
					$("#inboundQueue_" + service.name).stop().stop();
				/*
				if($("#emailQueue_"+serviceList[a].name).text()!="0" && $("#emailQueue_"+serviceList[a].name).text()!="") {
					$("#emailQueue_"+serviceList[a].name).fadeIn(250).fadeOut(250).fadeIn(250);
					isQueue = true;
				} else
					$("#emailQueue_"+serviceList[a].name).stop().stop();
				*/
			}
			ringAudio = document.getElementById("ringAudio");
			if (isQueue) {
				if (noRingStatuses.indexOf(userMode) == -1) {
					ringAudio.play();
				}
			//} else { // 20250410 'If' statement should not be the only statement in 'else' block
			} else if (!ringAudio.ended) {
					ringAudio.pause();
					ringAudio.currentTime = 0;
				//	} 20250410 for else if 
			}
		}

		function readyToAnswer(name) {
			if ($("#inboundQueue_" + name).text() == "0") return;
			try {
				parent.document.getElementById('phone-panel-no').value = '';
			} catch (err) {
				console.log(err);
			}
			$("#panelPhoneNo").text("");
			var c = serviceList.filter(function (v) { return v.name === name });
			//console.log(c[0]);
			wsWiseAgent.BindToACDGroup(c[0].acdGroup);
			setTimeout(function () { wsWiseAgent.Ready(); }, 500);

		}

		function wiseReadyToTalk() {
			wsWiseAgent.BindToACDGroup(0);
			setTimeout(function () { wsWiseAgent.Ready(); }, 500);
		}

		function wiseIdleMode() {
			if (userMode == "READY") wsWiseAgent.Break();
			wsWiseAgent.Idle();
		}

		function wiseBreakMode() {
			if (userMode != "IDLE") wsWiseAgent.Idle();
			wsWiseAgent.Break();
		}

		function toggleReadyIdle() {
			if (userMode == "READY") { // Ready -> Idle
				wsWiseAgent.Break();
				wsWiseAgent.Idle();
			} else {
				wsWiseAgent.BindToACDGroup(0); // -> Ready
				setTimeout(function () { wsWiseAgent.Ready(); }, 500);
			}
		}

		function acceptCall(callType, acdGroup, entry, oThis) {
			$("#softPhone").css("cursor");
			//console.log($("#softPhone").css("cursor"));
			if ($("#softPhone").css("cursor") == "wait") {
				alert("Waiting Wise accept call/messasge !!");
				return;
			}
			/*
			if(callType==CATY_BLOG)
				c = serviceList.filter(function (v) { return [CATY_WECHAT, CATY_FBMSG, CATY_FBFAN].indexOf(v.callType)>-1 && v.acdGroup==acdGroup });
			else
				c = serviceList.filter(function (v) { return v.callType==callType && v.acdGroup==acdGroup });
			*/
			var c = serviceList.filter(function (v) { return v.callType == callType && v.acdGroup == acdGroup });		//20250414 Add the "let", "const" or "var" keyword to this declaration of "c" to make it explicit.
			if (c.length == 0) return;

			//console.log(c);

			if (callType == CATY_INDB) {
				if ($("#inboundQueue_" + c[0].name).text() == "0") return;

				//wsWiseAgent.BindToACDGroup(c[0].acdGroup);
				setTimeout(function (p) { wsWiseAgent.BindToACDGroup(p.acdGroup); wsWiseAgent.Ready(); }.bind(this, { acdGroup: acdGroup }), 100);
				$("#softPhone").css("cursor", "wait");
				$("#queueListBar").find("[id*='QueueCount1']").css("cursor", "wait");
				setTimeout(function () {
					$("#softPhone").css("cursor", "default");
					$("#queueListBar").find("[id*='QueueCount1']").css("cursor", "pointer");
					if (userMode != "TALK" && userMode != "IDLE") wsWiseAgent.Idle();
				}, 500);
			} else {
				var rCalltype = callType;
				if (callType == CATY_BLOG && entry == "wechat") rCalltype = CATY_WECHAT;
				else if (callType == CATY_BLOG && entry == "whatsapp") rCalltype = CATY_WHATSAPP;
				else if (callType == CATY_BLOG && entry == "fbmsg") rCalltype = CATY_FBMSG;
				else if (callType == CATY_BLOG && entry == "fbpost") rCalltype = CATY_FBPOST;
				var layout = queueLayout[rCalltype];

				var miqCount = $("#" + layout.prefix + "QueueCount1_" + c[0].name).text();
				if (miqCount != "0") {
					// if($("#"+ layout.prefix +"QueueCount1_"+ c[0].name).text()=="0") {
					// 	try { window.parent.connClick(0,c[0].name,channels[callType],c[0].dnis,null); } catch(err){ console.log(err.message); }
					// 	return;
					// }

					if (userMode == "WORKING") {
						wsWiseAgent.Idle();
						setTimeout(function (p) { wsWiseAgent.AcceptMediaCallEx(DEVICE_ACDGROUP, p.acdGroup, p.callType); }.bind(this, { acdGroup: acdGroup, callType: callType }), 500);
					} else
						wsWiseAgent.AcceptMediaCallEx(DEVICE_ACDGROUP, acdGroup, callType);
					$("#softPhone").css("cursor", "wait");
					$("#queueListBar").find("[id*='QueueCount1']").css("cursor", "wait");
					setTimeout(function () {
						$("#softPhone").css("cursor", "default");
						$("#queueListBar").find("[id*='QueueCount1']").css("cursor", "pointer");
						if (userMode != "TALK" && userMode != "IDLE") wsWiseAgent.Idle();
					}, 500);
				}
				setTimeout(function (p) {
					getMediaCount(p.callType, p.dnis, loginId);
					if (oThis) {
						$(oThis).siblings().first().click();
					}
				}.bind(this, { callType: c[0].callType, dnis: c[0].dnis }), 1000);
				//Tiger 2020-6-2
				//try {if(miqCount=="0"){window.parent.connClick(0,c[0].name,channels[callType],c[0].dnis,null)}else{setTimeout(function(){window.parent.connClick(0,c[0].name,channels[callType],c[0].dnis,null)},1000)}} catch(err){ console.log(err.message); }
			}
			/*
			} else if(callType==CATY_EMAIL) {
				if($("#emailQueue_"+ name).text()=="0") return;
				if(userMode=="WORKING") {
					wsWiseAgent.Idle();
					setTimeout(function (p){wsWiseAgent.AcceptMediaCallEx (DEVICE_ACDGROUP, p.acdGroup, p.callType);}.bind(this, {acdGroup : c[0].acdGroup, callType: callType}),500);
				} else
					wsWiseAgent.AcceptMediaCallEx (DEVICE_ACDGROUP, c[0].acdGroup, callType);
			} else if(callType==CATY_VMAIL) {
				if($("#vmailQueue_"+ name).text()=="0") return;
				if(userMode=="WORKING") {
					wsWiseAgent.Idle();
					setTimeout(function (p){wsWiseAgent.AcceptMediaCallEx (DEVICE_ACDGROUP, p.acdGroup, p.callType);}.bind(this, {acdGroup : c[0].acdGroup, callType: callType}),500);
				} else
					wsWiseAgent.AcceptMediaCallEx (DEVICE_ACDGROUP, c[0].acdGroup, callType);
			} else if(callType==CATY_FAX) {
				if($("#faxQueue_"+ name).text()=="0") return;
				if(userMode=="WORKING") {
					wsWiseAgent.Idle();
					setTimeout(function (p){wsWiseAgent.AcceptMediaCallEx (DEVICE_ACDGROUP, p.acdGroup, p.callType);}.bind(this, {acdGroup : c[0].acdGroup, callType: callType}),500);
				} else
					wsWiseAgent.AcceptMediaCallEx (DEVICE_ACDGROUP, c[0].acdGroup, callType);
			}
			*/
		}
		function showQueueList() {
			$("#queueListBar").css("display", "none");
			$("#queueListBar").empty();



			//for (var i = 0; i < queueList.length; i++) {		// 20250414 Add the "let", "const" or "var" keyword to this declaration of "i" to make it explicit.
			for (var queueListItem of queueList) { 				// 20250414 Using `for-of` for cleaner iteration	// change queueList[i] to  queueListItem in following for loop
				//20240108 for skip showing zero count queue
				// if (queueList[i].source.equals('sleekflow')) // && queueList[i].waitCount < 1)
				// {
				//     return;
				// }



				//console.log(queueList[i]);
				var rCalltype = queueListItem.callType;
				if (queueListItem.callType == CATY_BLOG && queueListItem.entry == "wechat") rCalltype = CATY_WECHAT;
				else if (queueListItem.callType == CATY_BLOG && queueListItem.entry == "whatsapp") rCalltype = CATY_WHATSAPP;
				else if (queueListItem.callType == CATY_BLOG && queueListItem.entry == "fbmsg") rCalltype = CATY_FBMSG;
				else if (queueListItem.callType == CATY_BLOG && queueListItem.entry == "fbpost") rCalltype = CATY_FBPOST;
				var layout = queueLayout[rCalltype];

				var objDiv = document.createElement("div");
				//objDiv.setAttribute("class","queue_content");
				var source = queueListItem.source;

				//if (source != null && queueList[i].waitCount < 1 && (testMode == false)) {	20250407 Refactor the code to avoid using this boolean literal.
				if (source != null && queueList[i].waitCount < 1 && (!testMode)) {
					objDiv.setAttribute("style", "display:none;margin:5px 0px 0px 5px;box-shadow: 0 2px 4px 0 rgba(0,0,0,.14);border-radius: 3px;transition:.3s;background:#ffff;width:130px;height:80px;color:" + layout.color);
				}
				else {
					objDiv.setAttribute("style", "display:inline-block;margin:5px 0px 0px 5px;box-shadow: 0 2px 4px 0 rgba(0,0,0,.14);border-radius: 3px;transition:.3s;background:#ffff;width:130px;height:80px;color:" + layout.color);
				}



				//objDiv1.setAttribute("title","") ;

				var objDiv_Img = document.createElement("div");
				objDiv_Img.setAttribute("style", "display:inline-block;top:-5px;margin-left:10px;position:absolute;width:30%");

				var objImg = document.createElement("img");
				objImg.setAttribute("style", layout.style);
				objImg.src = layout.image;
				objDiv_Img.appendChild(objImg);

				objDiv.appendChild(objDiv_Img);


				var objQueueName = document.createElement("p");
				objQueueName.setAttribute("style", "display:inline-block;position:relative;text-align:right;margin:2px 0 0 -5px;width:100%");
				objQueueName.innerHTML = queueList[i].caption;
				objDiv.appendChild(objQueueName);

				var objQueueTime = document.createElement("p");
				objQueueTime.setAttribute("style", "display:inline-block;position:relative;text-align:right;margin:2px 0 0 -5px;width:100%;font-size:18px;color:#848484");
				objQueueTime.setAttribute("id", layout.prefix + "QueueTime_" + queueListItem.name);
				objQueueTime.innerHTML = (queueListItem.waitCount == 0) ? "00:00" : EncodeTime(queueListItem.waitTime);
				objDiv.appendChild(objQueueTime);

				var objDivQueue = document.createElement("div");
				objDivQueue.setAttribute("class", "queue_subcontent2");
				//objDivQueue.textContent=" ";

				var objQueueCount1 = document.createElement("div");
				if ($("#softPhone").css("cursor") == "wait")
					objQueueCount1.setAttribute("style", "display:inline-block;float:left;text-align:left;margin-left:5px;width:30%;border:2px solid #fff;color:#848484;cursor:wait;");
				else
					objQueueCount1.setAttribute("style", "display:inline-block;float:left;text-align:left;margin-left:5px;width:30%;border:2px solid #fff;color:#848484;cursor:pointer;");

				objQueueCount1.setAttribute("id", layout.prefix + "QueueCount1_" + queueListItem.name);
				objQueueCount1.textContent = queueListItem.waitCount;
				/*
				if(queueList[i].name!="Private")
					objQueueCount1.setAttribute("onclick", "acceptCall(" + queueList[i].callType+ "," + queueList[i].acdGroup +");");
				else
					objQueueCount1.setAttribute("onclick", "wsWiseAgent.AcceptMediaCall(" + queueList[i].acdGroup +");");
				*/

				////-------------------------------------------------------------------------------------------
				/////---------------------------------SHandler Update 2024-10-24---------------------////////////
				////----------------------------------------------------------------------------------------------
				if (queueList[i].source != "sleekflow") {
					objQueueCount1.setAttribute("onclick", "acceptCall(" + queueListItem.callType + "," + queueListItem.acdGroup + ",'" + queueListItem.entry + "',this);");
				} else {
					objQueueCount1.setAttribute("onclick", "acceptCall_Shandler(" + loginId + ",'" + top.token + "','" + queueListItem.entry + "','" + queueListItem.dnis + "');");
					//objQueueCount1.setAttribute("onclick", "acceptCall_test()");
				}
				////----------------------------------------------------------------------------------------------
				////----------------------------------------------------------------------------------------------
				////--------------------------------------------------------------------------------------------------

				objDivQueue.appendChild(objQueueCount1);
				//var objDivTemp = document.createElement("div");
				//objDivTemp.setAttribute("style","display:inline-block;width:1px");
				//objDivTemp.innerHTML="&nbsp;";
				//objDivQueue.appendChild(objDivTemp);
				//if ( queueList[i].callType== CATY_EMAIL || queueList[i].callType==CATY_VMAIL || queueList[i].callType==CATY_FAX) {
				//var objDivSubQueue = document.createElement("div");
				//objDivSubQueue.setAttribute("style","display:inline-block;float:right;text-align:right;margin-right:5px;width:30%;cursor:pointer;color:"+layout.color);
				if (queueList[i].callType == CATY_EMAIL || queueListItem.callType == CATY_VMAIL || queueListItem.callType == CATY_FAX) {
					var objQueueCount2 = document.createElement("div");
					objQueueCount2.setAttribute("id", layout.prefix + "QueueCount2_" + queueListItem.name);
					objQueueCount2.setAttribute("style", "display:inline-block;float:right;text-align:center;margin-right:5px;border:2px solid #eee;border-radius:3px;width:30%;cursor:pointer;");
					objQueueCount2.setAttribute("onclick", "setTimeout(function() {getMediaCount(" + queueListItem.callType + ",'" + queueListItem.dnis + "', " + loginId + ");},1200);try { window.parent.connClick(0,'" + queueListItem.name + "','" + channels[queueListItem.callType] + "','" + queueListItem.dnis + "','" + queueListItem.dnis + "',null);} catch (err) {console.log(err.message);}");
					objQueueCount2.textContent = queueListItem.mediaCount;
					//objDivSubQueue.appendChild(objQueueCount2);
					objDivQueue.appendChild(objQueueCount2);
				}
				//objDivQueue.appendChild(objDivSubQueue);

				//}
				objDiv.appendChild(objDivQueue);
				objDiv.setAttribute("id", layout.prefix + "Queue_" + queueListItem.name);
				queueListBar.appendChild(objDiv);
			}

			$("#queueListBar").css("width", queueList.length * 135);
			$("#queueListBar").css("display", "inline-block");

		}

		function queueTimeTicker() {
			
			/*for (var i = 0; i < queueList.length; i++) {		//20250414 Add the "let", "const" or "var" keyword to this declaration of "i" to make it explicit.
				var rCalltype = queueList[i].callType;
				if (queueList[i].callType == CATY_BLOG && queueList[i].entry == "wechat") rCalltype = CATY_WECHAT;
				else if (queueList[i].callType == CATY_BLOG && queueList[i].entry == "whatsapp") rCalltype = CATY_WHATSAPP;
				else if (queueList[i].callType == CATY_BLOG && queueList[i].entry == "fbmsg") rCalltype = CATY_FBMSG;
				else if (queueList[i].callType == CATY_BLOG && queueList[i].entry == "fbpost") rCalltype = CATY_FBPOST;
				var layout = queueLayout[rCalltype];

				var idCount = layout.prefix + "QueueCount1_" + queueList[i].name;
				//console.log($("#"+ idCount).text());
				if ($("#" + idCount).text() > 0) {
					var idTime = layout.prefix + "QueueTime_" + queueList[i].name;
					//var s=document.getElementById(idTime).innerHTML.split(":");
					var s = $("#" + idTime).html().split(":");
					queueList[i].waitTime = parseInt(s[0]) * 60 + parseInt(s[1]) + 1;
					document.getElementById(idTime).innerHTML = EncodeTime(queueList[i].waitTime);
				}
			}*/
			
			for (const queueItem of queueList) {				// 20250414 Expected a `for-of` loop instead of a `for` loop with this simple iteration.
				let rCalltype = queueItem.callType;
				
				if (queueItem.callType === CATY_BLOG && queueItem.entry === "wechat") {
					rCalltype = CATY_WECHAT;
				} else if (queueItem.callType === CATY_BLOG && queueItem.entry === "whatsapp") {
					rCalltype = CATY_WHATSAPP;
				} else if (queueItem.callType === CATY_BLOG && queueItem.entry === "fbmsg") {
					rCalltype = CATY_FBMSG;
				} else if (queueItem.callType === CATY_BLOG && queueItem.entry === "fbpost") {
					rCalltype = CATY_FBPOST;
				}
				
				const layout = queueLayout[rCalltype];
				const idCount = layout.prefix + "QueueCount1_" + queueItem.name;

				if ($("#" + idCount).text() > 0) {
					const idTime = layout.prefix + "QueueTime_" + queueItem.name;
					const s = $("#" + idTime).html().split(":");
					queueItem.waitTime = parseInt(s[0]) * 60 + parseInt(s[1]) + 1;
					document.getElementById(idTime).innerHTML = EncodeTime(queueItem.waitTime);
				}
			}
		}

		function initMediaCount() {
		//	for (var i = 0; i < serviceList.length; i++) {
			for (let service of serviceList) {				// 20250403 Expected a `for-of` loop instead of a `for` loop with this simple iteration.

			  //let service = serviceList[i];  // 20250403 for loop variable to for-of

				//if([CATY_EMAIL ,CATY_VMAIL, CATY_FAX].indexOf(serviceList[i].callType)!=-1)
				if (service.callType == CATY_EMAIL || service.callType == CATY_VMAIL || service.callType == CATY_FAX) {
					getMediaCount(service.callType, service.dnis, loginId);
				}
			}

		}

		function getMediaCount(callType, dnis, agentId) {
			var link = "";
			if (callType == CATY_EMAIL)
				link = config.wiseHost + "/WisePBX/api/Email/GetCount";
			else if (callType == CATY_VMAIL)
				link = config.wiseHost + "/WisePBX/api/Vmail/GetCount";
			else if (callType == CATY_FAX)
				link = config.wiseHost + "/WisePBX/api/Fax/GetCount";

			if (link == "") return;

			$.ajax({
				type: "POST",
				url: link,
				data: JSON.stringify({ "dnis": dnis, "agentId": agentId }),
				contentType: "application/json; charset=utf-8",
				dataType: "json",
				success: function (r) {

					if (r.result == "success") {
						showMediaCount(callType, dnis, parseInt(r.data));
					}
				},
				error: function (r) {
					console.log(r);
				},
			});
		}
		function showMediaCount(callType, dnis, mediaCount) {

			/*
			var idxServiceList = -1;
			serviceList.some(function(v, i) {
			if (v.callType==callType && v.dnis==dnis) {
				idxServiceList = i;
				return true;
				}
			});
			if (idxServiceList==-1) return;
			*/
			var idxServiceList = serviceList.findIndex(function (v) { return v.callType == callType && v.dnis == dnis });

			/*
			var idxQueueList = -1;
			queueList.some(function(v, i) {
			if (v.callType==callType && v.dnis==dnis) {
				idxQueueList = i;
				return true;
				}
			});
			*/

			var idxQueueList = queueList.findIndex(function (v) { return v.callType == callType && v.dnis == dnis });
			if (idxQueueList == -1) {
				var service = serviceList[idxServiceList];
				if (mediaCount != 0) {
					var q = {
						callType: parseInt(callType), acdGroup: service.acdGroup, name: service.name, caption: service.caption,
						dnis: service.dnis, showPriority: service.showPriority, waitTime: 0, waitCount: 0,
						mediaCount: mediaCount
					};
					queueList.push(q);
				}
			} else if (idxQueueList >= 0) {
				if (queueList[idxQueueList].waitCount == 0 && mediaCount == 0)
					queueList.splice(idxQueueList, 1);
				else {
					queueList[idxQueueList].mediaCount = mediaCount;
				}
			}
			queueList.sort(function (a, b) { var e = a.showPriority - b.showPriority; if (e == 0) return (b.waitTime - a.waitTime); else return e; });
			showQueueList();
		}

		function updateMediaCount(callType, dnis, checkCount) {
			//checkCount = typeof checkFlag !== 'undefined' ? checkCount : -1;
			checkCount = checkCount || -1;
			if (checkCount >= 0) {
				//console.log("updateMediaCount");
				//console.log(callType);
				//console.log(dnis);
				//console.log(checkCount);
			}
			//checkFlag = typeof checkFlag !== 'undefined' ? checkFlag : false;
			var checkFlag = false;
			var url;
			if (callType == CATY_EMAIL)
				url = config.wiseHost + "/WisePBX/api/Email/GetCount";
			else if (callType == CATY_VMAIL)
				url = config.wiseHost + "/WisePBX/api/Vmail/GetCount";
			else if (callType == CATY_FAX)
				url = config.wiseHost + "/WisePBX/api/Fax/GetCount";

			$.ajax({
				type: "POST",
				url: url,
				data: JSON.stringify({ "dnis": dnis, "agentId": loginId }),
				contentType: "application/json; charset=utf-8",
				dataType: "json",
				success: function (r) {
					//console.log(r);
					if (r.result == "success") {
						var mediaCount = parseInt(r.data);
						/*
						var idx = -1;
						queueList.some(function(v, i) {
						if (v.callType==callType && v.dnis==dnis) {
							idx = i;
							return true;
							}
						});
						*/
						var idx = queueList.findIndex(function (v) { return v.callType == callType && v.dnis == dnis });
						if (idx == -1) {
							if (mediaCount != 0) {

								/*
								var a = -1;
								serviceList.some(function(v, i) {
								if (v.callType==callType && v.dnis==dnis) {
									a = i;
									return true;
									}
								});
								*/
								var a = serviceList.findIndex(function (v) { return v.callType == callType && v.dnis == dnis });
								if (a == -1) return;
								var q = {
									callType: parseInt(callType), acdGroup: serviceList[a].acdGroup, name: serviceList[a].name, caption: serviceList[a].caption,
									dnis: serviceList[a].dnis, showPriority: serviceList[a].showPriority, waitTime: 0, waitCount: 0,
									mediaCount: mediaCount
								};
								console.log(q);
								queueList.push(q);
								queueList.sort(function (a, b) {
									var e = a.showPriority - b.showPriority;
									if (e == 0) e = b.waitTime - a.waitTime; else return e;
									if (e == 0) e = a.callType - b.callType; else return e;
									return e;
								});
								showQueueList();

							}
						}
						else {
							//console.log(queueList[idx]);
							if (checkCount > 0 && queueList[idx].mediaCount == mediaCount) {
								setTimeout(function (p) { updateMediaCount(p.callType, p.dnis, p.checkCount); }.bind(this, { callType: callType, checkCount: checkCount - 1 }), 500);	// 20250401 duplicate name 'callType'
								return;
							}

							//if(checkCount!=-1 && queueList[idx].mediaCount!=mediaCount) checkFlag = true;
							var rCalltype = queueList[idx].callType;
							if (queueList[idx].callType == CATY_BLOG && queueList[idx].entry == "wechat") rCalltype = CATY_WECHAT;
							else if (queueList[idx].callType == CATY_BLOG && queueList[idx].entry == "whatsapp") rCalltype = CATY_WHATSAPP;
							else if (queueList[idx].callType == CATY_BLOG && queueList[idx].entry == "fbmsg") rCalltype = CATY_FBMSG;
							else if (queueList[idx].callType == CATY_BLOG && queueList[idx].entry == "fbpost") rCalltype = CATY_FBPOST;
							var layout = queueLayout[rCalltype];

							queueList[idx].mediaCount = mediaCount;
							var idCount1 = layout.prefix + "QueueCount1_" + queueList[idx].name;
							if ($("#" + idCount1).text() == "0" && mediaCount == 0) {
								$("#" + layout.prefix + "Queue_" + queueList[idx].name).remove();
								queueList.splice(idx, 1);
								//showQueueList();
							} else {
								var idCount2 = layout.prefix + "QueueCount2_" + queueList[idx].name;
								$("#" + idCount2).text(mediaCount);
							}
							/*
							if(checkFlag == true){
								window.parent.connClick(callID,queueList[idx].name,channels[callType],mediaFrom,null);
							}
							*/
						}
						// window.parent.connClick(callID,queueList[idx].name,channels[callType],mediaFrom,null);
					}
				},
				error: function (r) {
					console.log(r);
				},
			});
		}
	</script>

	<script type="text/javascript">
		function wiseGetServiceInfo(serviceName) {
			var r = [];
			var s = serviceList.filter(function (v) { return v.name == serviceName });
			//for (var i = 0; i < s.length; i++) {				//20250414 Add the "let", "const" or "var" keyword to this declaration of "i" to make it explicit.
			//	var info = { channel: channels[s[i].callType], dnis: s[i].dnis };
			for (let item of s) {		// 20250414 Expected a for-of loop instead of a for loop with this simple iteration.
				const info = { channel: channels[item.callType], dnis: item.dnis };
				r.push(info);
			}
			return r;
		}

		function wiseMakeCall(serviceName, phoneNo) {
			try {
				if (phoneNo == null)
					phoneNo = parent.document.getElementById('phone-panel-no').value;
				else
					parent.document.getElementById('phone-panel-no').value = phoneNo;
			} catch (err) {

				console.log('Error in wiseMakeCall');	// 20250407 Exceptions should not be ignored
				console.log(err);

				if (phoneNo == null)
					phoneNo = document.getElementById('panelPhoneNo').value;
				else
					document.getElementById('panelPhoneNo').value = phoneNo;
			}
			var ANI = (serviceName == null) ? CallANI : outboundANI[serviceName].call;
			if (userMode == "WORKING") {
				wsWiseAgent.Idle();
				currCallInfo = { lastCallType: 0, lastCallID: 0, confCallID: 0, callSeq: [] };
				setTimeout(function () { wsWiseAgent.DialOut(phoneNo, ANI); }, 500);
			}
			else if (userMode == "IDLE") {
				currCallInfo = { lastCallType: 0, lastCallID: 0, confCallID: 0, callSeq: [] };
				wsWiseAgent.DialOut(phoneNo, ANI);
			}
			else if (userMode == "HOLD") {
				wsWiseAgent.DialOut(phoneNo, ANI);
			}

		}

		function wiseDropCall() {
			if (userMode == "TALK" || userMode == "DIALING")
				wsWiseAgent.Hangup();
			else if (userMode != "IDLE")
				wsWiseAgent.Idle();
		}

		function wiseHoldCall() {
			if (userMode == "TALK") {
				wsWiseAgent.Hold();
				var parentholdBtn = parent.$("#icon-line-1")
				parentholdBtn.attr("title", "Unhold Call");
				parentholdBtn.find('i').removeClass('fa-pause').addClass('fa-play');
			} else if (userMode == "HOLD") {
				wsWiseAgent.Unhold(holdingConnIDs[holdingConnIDs.length - 1]);
			}
		}
		function wiseMakeConference() {
			if (confConnID != 0) {
				alert("conference call was created.");
				return;
			}
			if (onlineConnIDs.length >= 2) {
				var i = onlineConnIDs.findIndex(function (v) { return v.connID != currconnID; });
				if (i != -1) {
					isMakeConf = true;
					wsWiseAgent.CreateConference(onlineConnIDs[i].connID);
				}
			}

			/*
			if(confConnID==0) {
				if(holdingConnIDs.length!=0) {
					isMakeConf=true;
					wsWiseAgent.CreateConference(holdingConnIDs[holdingConnIDs.length-1]);
				}
			}
			else {
				wsWiseAgent.AddMemberToConference(confConnID);
			}
			*/
		}

		function wiseTransferCall(msg) {
			/*
			if (msg==null) msg="";
			if(holdingConnIDs.length!=0) {
				wsWiseAgent.TransferCall(holdingConnIDs[holdingConnIDs.length-1],msg);
			}
			*/
			if (msg == null) msg = "";
			if (onlineConnIDs.length >= 2) {
				i = onlineConnIDs.findIndex(function (v) { return v.connID != currconnID; });
				if (i != -1) {
					if (onlineConnIDs[i].callType == CATY_INTER) {
						alert("Please hold current call and talk with other agent to transfer call.");
						return;
					}
					else {
						wsWiseAgent.TransferCall(onlineConnIDs[i].connID, msg);
					}
				}
			}
		}

		function wiseCallAgent(agentNo) {
			try {
				if (agentNo == null)
					agentNo = parent.document.getElementById('phone-panel-no').value;
			} catch (err) {

				console.log('Error in wiseCallAgent');	// 20250407 Exceptions should not be ignored
				console.log(err);

				if (agentNo == null)
					agentNo = document.getElementById('panelPhoneNo').value;
			}
			wsWiseAgent.DialAgent(agentNo);
		}

		function wiseSendDTMF(val) {
			if (userMode == "TALK") {
				wsWiseAgent.SendDTMFTone(val);
			}
		}

		function wiseAnswerTicket(ticketId) {
			if (ticketId == "") return;
			wsWiseAgent.UpdateTicket(ticketId);
		}

		function wiseGetTicketMsg(ticketId) {
			if (ticketId == "") return;
			wsWiseAgent.GetTicketMsg(ticketId);
		}

		function wiseTerminalTicket(ticketId) {
			if (ticketId == "") return;
			var idx = ticketList.findIndex(function (v) { return v.ticket_id == ticketId });
			if (idx != -1) ticketList.splice(idx, 1);
			wsWiseAgent.CompleteTicket(ticketId);
		}

		function wiseCompleteTicket(ticketId) {
			wsWiseAgent.CompleteTicket(ticketId);
		}

		function wiseAssignToChatRoom(ticket_id, assign_to, action) {
			wsWiseAgent.AssignToChatRoom(ticket_id, assign_to, action);
		}

		var wiseSendSocialMsg_Async = function () {
			var _ref = _asyncToGenerator(regeneratorRuntime.mark(function _callee(ticketId, msgText, completedMsgIdList, callback, msgId) {
				return regeneratorRuntime.wrap(function _callee$(_context) {
					while (1) {
						switch (_context.prev = _context.next) {
							case 0:
								var ticket = ticketList.filter(function (v) { return v.ticket_id == ticketId })[0];

								if (ticket.entry == "fb_comment" || ticket.entry == "fb_post") {
									//console.log('msgId @ wiseSendSocialMsg_Async');console.log(msgId);
									if (msgId == -1) {
										wsWiseAgent.SendMsgToConnector(ticketId, -1, completedMsgIdList, msgText);
									} else {
										//for (var i = 0; i < completedMsgIdList.length; i++) {		// 20250403 Expected a `for-of` loop instead of a `for` loop with this simple iteration.
										//	var messageId = completedMsgIdList[i];
										for (let messageId of completedMsgIdList)	{
											wsWiseAgent.SendMsgToConnector(ticketId, messageId, [messageId], msgText);
										}
									}
									// wsWiseAgent.SendMsgToConnector(ticketId, -1, completedMsgIdList, msgText);
								} else {
									wsWiseAgent.SendMsgToConnector(ticketId, 0, [0], msgText);
									setTimeout(function () {
										sendMsgResult.result = "fail";		//sendMsgResult.result == "fail";	Expected an assignment or function call and instead saw an expression.	
										_context.next = 5;
									}, 3000);
								}
								break;	// 20250328 (JavaScript) Switch cases should end with an unconditional "break" statement
							case 1:
								//if (!(sendMsgResult.result == "")) {	// 20250321	Use the opposite operator (!=) instead.
								if (sendMsgResult.result != "") {	
									_context.next = 5;
									break;
								}

								_context.next = 4;
								return sleep(500);

							case 4:
								_context.next = 1;
								break;
							case 5:
								callback(sendMsgResult);
								break; // 20250328 (JavaScript) Switch cases should end with an unconditional "break" statement
							case 6:
							case "end":
								return _context.stop();
						}
					}
				}, _callee, this);
			}));

			return function wiseSendSocialMsg_Async(_x, _x2, _x3, _x4, _x5) {
				return _ref.apply(this, arguments);
			};
		}();

		function wiseSendSocialMsg_Ex(ticketId, msgText, completedMsgIdList, callback, msgId) {
			if (ticketId == "") return;
			// if(ticketId=="" || msgText=="") return;
			sendMsgResult.result = "";
			sendMsgResult.data = {};
			wiseSendSocialMsg_Async(ticketId, msgText, completedMsgIdList, callback, msgId);
		}

		function wiseSendSocialMsg(ticketId, msgText, completedMsgIdList) {
			if (ticketId == "" || msgText == "") return;
			var ticket = ticketList.filter(function (v) { return v.ticket_id == ticketId })[0];

			if (ticket.entry == "fb_comment" || ticket.entry == "fb_post") {
			 //for (var i = 0; i < completedMsgIdList.length; i++) {		// 20250403 Expected a `for-of` loop instead of a `for` loop with this simple iteration.
				//	var msgId = completedMsgIdList[i];
				for (let msgId of completedMsgIdList ) {
					wsWiseAgent.SendMsgToConnector(ticketId, msgId, [msgId], msgText);
				}
			} else {
				wsWiseAgent.SendMsgToConnector(ticketId, 0, [0], msgText);
			}
		}

		function wiseGetFBPost(ticketId) {
			wsWiseAgent.GetFaceBookPost(loginId, ticketId);
		}

		function wiseUploadSocialFile(ticketId, fileId, callback) {
			var _fileUpload = $("#" + fileId).get(0);
			var _fileData = new FormData();
			//for (var i = 0; i < _fileUpload.files.length; i++)	{
			//	let uploadFile = _fileUpload.files[i];	// 20250403 Expected a `for-of` loop instead of a `for` loop with this simple iteration.
			for (let uploadFile of _fileUpload.files) {
				fileData.append("files", uploadFile);
			}

			_fileData.append('ticketId', ticketId);
			_fileData.append('agentId', loginId);

			//console.log(_fileData);
			$.ajax({
				url: config.wiseHost + '/api/SocialMedia/UploadFile',
				type: "POST",
				contentType: false, // Not to set any content header
				processData: false, // Not to process data
				dataType: 'json',
				data: _fileData,
				success: function (r) {
					if (typeof callback === "function") { callback(r.data); }
				},
				error: function (err) {
					console.log(err);
				}
			});
		}
		//
		var wiseSendSocialFile_Async = function () {
			var _ref = _asyncToGenerator(regeneratorRuntime.mark(function _callee(ticketId, filePath, completedMsgIdList, callback) {
				return regeneratorRuntime.wrap(function _callee$(_context) {
					while (1) {
						switch (_context.prev = _context.next) {
							case 0:
								var ticket = ticketList.filter(function (v) { return v.ticket_id == ticketId })[0];
								if (ticket.entry == "fb_comment" || ticket.entry == "fb_post") {
									//for (var i = 0; i < completedMsgIdList.length; i++) {		// 20250403 Expected a `for-of` loop instead of a `for` loop with this simple iteration.
									 // var msgId = completedMsgIdList[i];
									for (let msgId of completedMsgIdList) {
										wsWiseAgent.SendFileToConnector(ticketId, msgId, [msgId], filePath);
									}
								} else {
									wsWiseAgent.SendFileToConnector(ticketId, 0, [0], filePath);
								}
								break;	//	20250331 (JavaScript) Switch cases should end with an unconditional "break" statement 
							case 1:
							   //if (!(sendMsgResult.result == "")) {	// 20250321	Use the opposite operator (!=) instead.
								if (sendMsgResult.result != "") {	
									_context.next = 5;
									break;
								}

								_context.next = 4;
								return sleep(500);

							case 4:
								_context.next = 1;
								break;
							case 5:
								callback(sendFileResult);
								break; 					// 20250331 (JavaScript) Switch cases should end with an unconditional "break" statement
							case 6:
							case "end":
								return _context.stop();
						}
					}
				}, _callee, this);
			}));

			return function wiseSendSocialFile_Async(_x, _x2, _x3, _x4) {
				return _ref.apply(this, arguments);
			};
		}();

		function wiseSendSocialFile_Ex(ticketId, filePath, completedMsgIdList, callback) {
			sendFileResult.result = "";
			sendFileResult.data = {};
			wiseSendSocialFile_Async(ticketId, filePath, completedMsgIdList, callback);
		}

		function wiseSendSocialFile(ticketId, filePath, completedMsgIdList) {


			var ticket = ticketList.filter(function (v) { return v.ticket_id == ticketId })[0];
			if (ticket.entry == "fb_comment" || ticket.entry == "fb_post") {
				//for (var i = 0; i < completedMsgIdList.length; i++) {		// 20250407 Expected a `for-of` loop instead of a `for` loop with this simple iteration.
				for (var msgId of completedMsgIdList) {
					//var msgId = completedMsgIdList[i];
					wsWiseAgent.SendFileToConnector(ticketId, msgId, [msgId], filePath);
				}
			} else {
				wsWiseAgent.SendFileToConnector(ticketId, 0, [0], filePath);
			}
			//waitTimeOut(1000, function(){console.log("waitTimeOut");});
		}

		function wiseSetMediaHandled(channel, mediaId, caseNo) {
			//var callType= Object.keys(channels).find( function (key){ return channels[key] ===channel});
			//var _callType= parseInt(Object.keys(channels)[Object.values(channels).indexOf(channel)]);
			var _callType = parseInt(Object.keys(channels)[Object.keys(channels).map(key => channels[key]).indexOf(channel)]);
			if (isNaN(_callType)) return;

			var _link = "";
			if (_callType == CATY_EMAIL)
				_link = config.wiseHost + "/WisePBX/api/Email/SetHandled";
			else if (_callType == CATY_VMAIL)
				_link = config.wiseHost + "/WisePBX/api/Vmail/SetHandled";
			else if (_callType == CATY_FAX)
				_link = config.wiseHost + "/WisePBX/api/Fax/SetHandled";
			if (_link == "") return;
			$.ajax({
				type: "POST",
				url: _link,
				contentType: "application/json; charset=utf-8",
				dataType: "json",
				data: JSON.stringify({ "callType": _callType, "mediaId": mediaId, "caseNo": caseNo, "updatedBy": loginId }),
				success: function (r) {
					var _dnis = r.data;
					updateMediaCount(_callType, _dnis, 10);
				},
				error: function (r) {
					console.log(r);
				},
			});

		}

		function wiseAssignAgent(channel, mediaIds, assignTo, callback) {
			//var callType= Object.keys(channels).find( function (key){ return channels[key] ===channel});
			//var _callType= parseInt(Object.keys(channels)[Object.values(channels).indexOf(channel)]);
			var _callType = parseInt(Object.keys(channels)[Object.keys(channels).map(key => channels[key]).indexOf(channel)]);
			if (isNaN(_callType)) return;
			//console.log(_callType);
			var _link = "";
			if (_callType == CATY_EMAIL)
				_link = config.wiseHost + "/WisePBX/api/Email/AssignAgent";
			else if (_callType == CATY_VMAIL)
				_link = config.wiseHost + "/WisePBX/api/Vmail/AssignAgent";
			//link= "http://localhost:51453/api/Vmail/AssignAgent";
			else if (_callType == CATY_FAX)
				_link = config.wiseHost + "/WisePBX/api/Fax/AssignAgent";
			if (_link == "") return;
			$.ajax({
				type: "POST",
				url: _link,
				contentType: "application/json; charset=utf-8",
				dataType: "json",
				data: JSON.stringify({ "mediaIds": mediaIds, "assignTo": assignTo, "updatedBy": loginId }),
				success: function (r) {
					//console.log(r);
					var _dnisArray = $.unique(r.data.map(function (d) { return d.dnis; }));
					for (let dnis of _dnisArray) { 	 // for (var i = 0; i < _dnisArray.length; i++) { 	//20250414 Expected a `for-of` loop instead of a `for` loop with this simple iteration.
						//console.log(dnis); 
						
						// Replace `updateMediaCount(_callType, _dnisArray[i], 10);` with:
						updateMediaCount(_callType, dnis, 10); 
					}
					
					
					if (typeof callback === "function") { callback(); }
				},
				error: function (r) {
					console.log(r);
				},
			});

		}

		function wiseGetAgentName(agentIds, callback) {
			//var callType= Object.keys(channels).find( function (key){ return channels[key] ===channel});
			$.ajax({
				type: "POST",
				url: config.wiseHost + "/WisePBX/api/SocialMedia/GetAgentName",
				contentType: "application/json; charset=utf-8",
				dataType: "json",
				data: JSON.stringify({ "agentIds": agentIds }),
				success: function (r) {
					//console.log(r);
					if (r.result == "success") {
						if (typeof callback === "function") { callback(r.data); }
					}
				},
				error: function (r) {
					console.log(r);
				},
			});

		}

		function wiseSendSMS(serviceName, phoneNo, shortMsg) {
			var _returnJson;
			_returnJson = JSON.parse($.ajax({
				type: "POST",
				async: false,
				url: config.wiseHost + "/WisePBX/api/Outbound/CreateCaseId",
				contentType: "application/json; charset=utf-8",
				dataType: "json",
				data: JSON.stringify({ "agentId": loginId }),
			}).responseText);

			var _mediaCaseId = -1;
			if (_returnJson.result == "success")
				_mediaCaseId = _returnJson.data;
			else {
				if (_returnJson.result == "fail") console.log(_returnJson.details);
				return -1;
			}
			var smsANI = outboundANI[serviceName].sms;
			wsWiseAgent.SendSMS_UC(phoneNo, smsANI, _mediaCaseId, "", shortMsg);

			_returnJson = JSON.parse($.ajax({
				type: "POST",
				async: false,
				url: config.wiseHost + "/WisePBX/api/Outbound/GetCallId",
				contentType: "application/json; charset=utf-8",
				dataType: "json",
				data: JSON.stringify({ "callType": CATY_OUTSMS, "caseId": _mediaCaseId, "agentId": loginId }),
			}).responseText);

			if (_returnJson.result == "success")
				return _returnJson.data;
			else {
				if (_returnJson.result == "fail") console.log(_returnJson.details);
				return -1;
			}
		}
		function wiseInviteAgentToChat(agentId, ticketId, msgContent) {
			wsWiseAgent.InviteAgentToChat(agentId, ticketId, msgContent);
		}
		function wiseSendMessage_UC(DeviceType, DeviceID, Message) {
			wsWiseAgent.SendMessage_UC(DeviceType, DeviceID, Message);
		}
		function wiseSendCSInputtingState(ticketId) {
			wsWiseAgent.SendCSInputtingState(loginId, ticketId);
		}
		function sleep(ms) {
			return new Promise(function (res) {
				setTimeout(res, ms);
			});
		};

		/*
		async function wiseSendEmail_Async(serviceName, emailTo, emailCc, emailSubject, emailContent, attachedFiles) {
				var emailFrom = outboundANI[serviceName].email;
			wsWiseAgent.SendEmail_UC(emailTo,emailCc,"",emailFrom,emailSubject,attachedFiles ,0,emailFrom,1,emailContent);
				while(callID==0) {
				await sleep(1000);
			}
		  return callID;
		}
		*/

		// polyfill awiat/async
		var wiseSendEmail_Async = function () {
			var _ref = _asyncToGenerator(regeneratorRuntime.mark(function _callee(serviceName, emailTo, emailCc, emailSubject, emailContent, attachedFiles) {
				return regeneratorRuntime.wrap(function _callee$(_context) {
					while (1) {
						switch (_context.prev = _context.next) {
							case 0:
								var emailFrom = outboundANI[serviceName].email;
								wsWiseAgent.SendEmail_UC(emailTo, emailCc, "", emailFrom, emailSubject, attachedFiles, 0, emailFrom, 3, emailContent);
								break;			// 20250331 (JavaScript) Switch cases should end with an unconditional "break" statement
							case 1:
								//if (!(callID == 0)) {		// 20250321 Use the opposite operator (!=) instead.
								if (callID != 0) {
									_context.next = 6;
									break;
								}

								_context.next = 4;
								return sleep(500);

							case 4:
								_context.next = 1;
								break;

							case 6:
								return _context.abrupt("return", callID);

							case 7:
							case "end":
								return _context.stop();
						}
					}
				}, _callee, this);
			}));

			return function wiseSendEmail_Async(_x, _x2, _x3, _x4, _x5, _x6) {
				return _ref.apply(this, arguments);
			};
		}();

		function wiseSendEmail_Ex(serviceName, emailTo, emailCc, emailSubject, emailContent, attachedFiles, callback) {
			var r = wiseSendEmail_Async(serviceName, emailTo, emailCc, emailSubject, emailContent, attachedFiles);
			r.then(function (v) { callback(v); });
		}
		function wiseSendEmail(serviceName, emailTo, emailCc, emailSubject, emailContent, attachedFiles) {

			var _returnJson;
			_returnJson = JSON.parse($.ajax({
				type: "POST",
				async: false,
				url: config.wiseHost + "/WisePBX/api/Outbound/CreateCaseId",
				contentType: "application/json; charset=utf-8",
				dataType: "json",
				data: JSON.stringify({ "agentId": loginId }),
			}).responseText);

			var _mediaCaseId = -1;
			if (_returnJson.result == "success")
				_mediaCaseId = _returnJson.data;
			else {
				if (_returnJson.result == "fail") console.log(_returnJson.details);
				return -1;
			}

			var _returnJson = JSON.parse($.ajax({
				type: "POST",
				async: false,
				url: config.wiseHost + "/WisePBX/api/Email/UploadContent",
				contentType: "application/json; charset=utf-8",
				dataType: "json",
				data: JSON.stringify({ "content": emailContent, "agentId": loginId }),
			}).responseText);
			var _filePath;
			if (_returnJson.result == "success") {
				_filePath = _returnJson.data.filePath;
			} else {
				console.log(_returnJson.details);
				return -1;
			}

			var emailFrom = outboundANI[serviceName].email;
			wsWiseAgent.SendEmail_UC(emailTo, emailCc, "", emailFrom, emailSubject, attachedFiles, _mediaCaseId, emailFrom, 3, _filePath);
			//wsWiseAgent.SendEmail_UC(emailTo,emailCc,"",emailFrom,emailSubject,attachedFiles ,_mediaCaseId,emailFrom,3,emailContent);



			_returnJson = JSON.parse($.ajax({
				type: "POST",
				async: false,
				url: config.wiseHost + "/WisePBX/api/Outbound/GetCallId",
				contentType: "application/json; charset=utf-8",
				dataType: "json",
				data: JSON.stringify({ "callType": CATY_EMAIL_OUT, "caseId": _mediaCaseId, "agentId": loginId }),
			}).responseText);

			if (_returnJson.result == "success") {
				return _returnJson.data;
			} else {
				if (_returnJson.result == "fail") console.log(_returnJson.details);
				return -1;
			}
		}

		function wiseSendFax(serviceName, faxNo, faxFile, coverSubject, coverMsg, coverAttn, coverSender, coverCompany) {
			var _returnJson;
			_returnJson = JSON.parse($.ajax({
				type: "POST",
				async: false,
				url: config.wiseHost + "/WisePBX/api/Outbound/CreateCaseId",
				contentType: "application/json; charset=utf-8",
				dataType: "json",
				data: JSON.stringify({ "agentId": loginId }),
			}).responseText);

			var _mediaCaseId = -1;
			if (_returnJson.result == "success")
				_mediaCaseId = _returnJson.data;
			else {
				if (_returnJson.result == "fail") console.log(_returnJson.details);
				return -1;
			}

			var faxANI = outboundANI[serviceName].fax;
			var faxCover = outboundANI[serviceName].faxCover;
			wsWiseAgent.SendFaxExP_UC(0, faxNo, coverMsg, faxFile, coverAttn, coverSubject, coverCompany, faxCover, _mediaCaseId, faxANI, coverSender, 1);

			_returnJson = JSON.parse($.ajax({
				type: "POST",
				async: false,
				url: config.wiseHost + "/WisePBX/api/Outbound/GetCallId",
				contentType: "application/json; charset=utf-8",
				dataType: "json",
				data: JSON.stringify({ "callType": CATY_FAX_OUT, "caseId": _mediaCaseId, "agentId": loginId }),
			}).responseText);

			if (_returnJson.result == "success")
				return _returnJson.data;
			else {
				if (_returnJson.result == "fail") console.log(_returnJson.details);
				return -1;
			}
		}

		function wiseAnswerDirectCall() {
			if (userMode != "TALK" && userMode != "DIALING" && directCalls.length > 0) {
				if (userMode != "IDLE") wsWiseAgent.Idle();
				//wsWiseAgent.AcceptCallEx(1, directCalls.shift());
				wsWiseAgent.AcceptMediaCall(directCalls.shift());
				if (directCalls.length == 0)
					window.parent.$("#panel-direct-count").css("background", "");
				else
					window.parent.$("#panel-direct-count").css("background", "blue");
				window.parent.$("#direct-count-text").text("Queue: " + String(directCalls.length));
			}
		}

		async function wiseSendWhatsAppMsg(serviceName, phoneNo, TemplateId, props, callback) {
			var ani = outboundANI[serviceName].whatsapp;
			var no = "whatsapp:+";
			no += (String(phoneNo).length <= 8) ? "852" + String(phoneNo) : String(phoneNo);

			templateMsgResult = {};
			wsWiseAgent.SendTemplateMsg(ani, no, TemplateId, props, 4);
			while (Object.keys(templateMsgResult).length == 0) {
				await sleep(100);
			}
			// return templateMsgResult;
			callback(templateMsgResult.ticket_id);
		}
		// phoneList: "9xxxxxxx,6xxxxxxx,5xxxxxxx"
		async function wiseSendWhatsAppMsgEx(serviceName, phoneList, TemplateId, props, callback) {
			var ani = outboundANI[serviceName].whatsapp;
			var phoneNo = phoneList.split(",");
			templateMsgResultEx = [];
			
			/*for (var i = 0; i < phoneNo.length; i++) {				//20250414 Add the "let", "const" or "var" keyword to this declaration of "i" to make it explicit.
				var no = "whatsapp:+";
				no += (phoneNo[i].length <= 8) ? "852" + phoneNo[i] : phoneNo[i];
				wsWiseAgent.SendTemplateMsg(ani, no, TemplateId, props, 4);
			}*/
			for (let phone of phoneNo) {							//20250414 Expected a `for-of` loop instead of a `for` loop with this simple iteration.
				let no = "whatsapp:+";
				no += (phone.length <= 8) ? "852" + phone : phone;
				wsWiseAgent.SendTemplateMsg(ani, no, TemplateId, props, 4);
			}
			while (templateMsgResultEx.length != phoneNo.length) {
				await sleep(100);
			}
			templateMsgResult.ticket_id = templateMsgResultEx;
			callback(templateMsgResult);
		}

		function wiseGetWhatsappMsg(serviceName, startDate, endDate, phoneNo, callback) {
			var companyCode = outboundANI[serviceName].whatsapp;
			if (companyCode == undefined) {
				alert("Whatsapp of [" + serviceName + "] is undefined");
				return;
			}
			$.ajax({
				type: "POST",
				url: config.wiseHost + "/WisePBX/api/SocialMedia/GetWhatsapp",
				data: JSON.stringify({ "companyCode": companyCode, "startDate": startDate, "endDate": endDate, "phoneNo": phoneNo }),
				contentType: "application/json; charset=utf-8",
				dataType: "json",
				success: function (r) {
					if (r.result == "success") {
						callback(r.data);
					}
				},
				error: function (r) {
					console.log(r);
				},
			});
		}

		function WiseGetAgentList(name, entry) {
			if (entry == "webchat") callType = CATY_WEBCHAT;
			else if (entry == "email") callType = CATY_EMAIL;
			else if (entry == "vmail") callType = CATY_VMAIL;
			else if (entry == "fax") callType = CATY_FAX;
			else callType = CATY_BLOG;

			var s = serviceList.filter(function (v) { return v.name == name && v.callType == callType });
			if (s.length == 0) return;
			acdGroupMemberBy = "WiseGetAgentList";
			wsWiseAgent.GetACDGroupMember(s[0].acdGroup);
		}

		function WiseGetAgentListEx() {
			wsWiseAgent.GetLogonAgentEx();
		}



		function getAgentListFromWise() {
			wsWiseAgent.GetLogonAgentEx();
		}
		function WiseStartMonitorCall(agentId, typeId) {
			/*
			typeId: 0 	Barge In
			typeId: 1 	Silent
			typeId: 2 	Conference
			typeId: 4 	Coach
			*/
			if (monitoredAgentId != 0 && monitoredAgentId != agentId) {
				wsWiseAgent.StopMonitorAgent(monitoredAgentId); // You are monitoring someone and you monitor another one now, so you need to stop monitoring first
				setTimeout(function (p) { monitoredAgentId = p.agentId; wsWiseAgent.MonitorAgent(p.agentId, p.typeId); }.bind(this, { agentId: agentId, typeId: typeId }), 500);
			} else {
				if (userMode != "IDLE") wsWiseAgent.Idle(); // If user In Break or Ready or Working mode cannot monitor call
				monitoredAgentId = agentId;
				wsWiseAgent.MonitorAgent(agentId, typeId);
			}
		}

		function WiseEndMonitorCall() {
			if (monitoredAgentId != 0) {
				wsWiseAgent.StopMonitorAgent(monitoredAgentId);
				monitoredAgentId = 0;
			}
		}

		function WiseStartMontiorChat(ticketIdArr, agentId) {
			var allUnderMonitoring = true;
			//for (var j = 0; j < ticketIdArr.length; j++) {	// 20250403 Expected a `for-of` loop instead of a `for` loop with this simple iteration.
				//var ticketId = ticketIdArr[j];
			for (let ticketId of ticketIdArr) {
				var i = monitoredTicketList.findIndex(function (v) { return v.ticketId == ticketId });
				if (i == -1) {
					monitoredTicketList.push({ "ticketId": ticketId, "agentId": agentId, "mode": "S" });
					wsWiseAgent.AssignToChatRoom(ticketId, loginId, "M");
					allUnderMonitoring = false;
				}
			}
			if (allUnderMonitoring) {
				// till chrome version 14, still no window.focus();
				alert("All chats are already under monitoring");
			} else {
				alert("You are entering the chat(s)."); // The alert is for switching the popup
			}
		}

		function WiseEndMontiorChat(ticketId) {
			var i = monitoredTicketList.findIndex(function (v) { return v.ticketId == ticketId });
			if (i == -1) {
				alert("The chat room is not under monitoring.");
			} else {
				wsWiseAgent.AssignToChatRoom(ticketId, loginId, "E"); // Exit monitored chat
				monitoredTicketList.splice(i, 1);
			}
		}

		function WiseMontiorChat(ticketId, mode) {
			/*
			mode: "C" Conference
			mode: "B" Barge In
			*/
			var i = monitoredTicketList.findIndex(function (v) { return v.ticketId == ticketId });
			if (i == -1) {
				alert("The chat room is not under monitoring.");
		//  } else { // 20250410 'If' statement should not be the only statement in 'else' block
			} else if (mode == "C" && monitoredTicketList[i].mode == "S") {
					monitoredTicketList[i].mode = "C";
					wsWiseAgent.AssignToChatRoom(ticketId, loginId, "C");
					// Take out from monitor
					monitoredTicketList.splice(i, 1);
			} else if (mode == "B" && monitoredTicketList[i].mode != "B") {
					wsWiseAgent.AssignToChatRoom(ticketId, loginId, "B");
					wsWiseAgent.AssignToChatRoom(ticketId, monitoredTicketList[i].agentId, "R");
					monitoredTicketList[i].mode = "B";
					monitoredTicketList[i].agentId = parseInt(loginId)
					// Take out from monitor
					monitoredTicketList.splice(i, 1);
				//	} //20250410 for else if
			}
		}

		function wiseGetACDGroupMember(gid) {
			acdGroupMemberBy = "wiseGetACDGroupMember";
			wsWiseAgent.GetACDGroupMember(gid);
		}

		function wiseAddACDGroupMember(gid, aid) {
			wsWiseMonitor.AddDeviceMember(gid, aid);
		}

		function wiseDelACDGroupMember(gid, aid) {
			wsWiseMonitor.RemoveDeviceMember(gid, aid);
		}

		function wiseOpenMonitor() {
			// agentLvId 1,2 also can see the agent status but cannot add or remove acd
			// if (agentLevelID != 3 && agentLevelID != 4){
			// 	alert("Please contact IT support to grant the right to have Wallboard");
			// } else
			if (wsRM == null) {
				wsWiseMonitor.OpenWebsocket(WISEIP);
			} else {
				return;
			}
		}

		addEventListener(document, 'AddToChatRoom', function (e) {
			var obj = e.detail;
			triggerEvent(window.parent.document, 'onAddToChatRoom', obj);
		});

		addEventListener(document, 'RmFromChatRoom', function (e) {
			var obj = e.detail;
			triggerEvent(window.parent.document, 'onRmFromChatRoom', obj);
		});

		/*
		function wiseRemoveAttachement(attachedFiles)
		{
			var _files=attachedFiles.split(";");
			for (_file in _files) {
				if (_file.indexOf("\\Uploads\\")==-1) return;
			}
			$.ajax({
				type: "POST",
				url: config.wiseHost+"/WisePBX/api/Outbound/RemoveAttachment",
				contentType: "application/json; charset=utf-8",
				dataType: "json",
				data : "{\"files\": [\"" + attachedFiles.replace(",","\",\"").replace(" ","") + "\"]",
				success: function (r) {
					console.log(r);
				},
				error: function (r) {
					console.log(r);
				},
			});
		}

		function wiseUploadAttachement(fileId, appCaseNo)
		{
			var _fileUpload = $("#" + fileId).get(0);
			var _fileData = new FormData();
			for(var i=0;i<_fileUpload.files.length;i++)
				fileData.append("files", _fileUpload.files[i]);

			_fileData.append('agentId', loginId);
			_fileData.append('caseNo', appCaseNo);
			console.log(_fileData);
			$.ajax({
				url: 'http://localhost:51453/api/Outbound/UploadAttachment',
				type: "POST",
				contentType: false, // Not to set any content header
				processData: false, // Not to process data
				dataType: 'json',
				data: _fileData,
				success: function (r) {
					console.log(r);
				},
				error: function (err) {
					console.log(err);
				}
			});
		}
		*/


		function TestGetMsg() {
			//console.log("aaa="+$("#softPhone").css("cursor"));
			//console.log($("#queueListBar").find("[id*='QueueCount1']"));
			$("#queueListBar").find("[id*='QueueCount1']").css("cursor", "wait");

			//wiseGetAgentName([1,2],function(r){console.log(r);});
			//WiseGetAgentList('NP360','fb_comment');
			wiseSendEmail('OneCallFix', 'tigerpkchong@eprotel.com.hk', '', 'RE: testing', '<html><boby><h1> Hello</h1></boby></html>', '');
			/*
			var a = parseInt(Object.keys(channels)[Object.values(channels).indexOf("x")]);
			console.log(isNaN(a));
			console.log(typeof a);
			return;
			*/
			//wsWiseAgent.GetTicketMsg(1205544477);
			//wiseSendSocialMsg(ticketList[0].ticket_id,"Test form Tiger");

			//wiseSendSocialFile(ticketList[0].ticket_id,"//172.17.7.40/WisePBX/Uploads/11-2-4c3dba32-9267-4bf2-9460-3ad82f79f7c5/Penguins.jpg");
			//wiseSendSocialFile(ticketList[0].ticket_id,"d:\\Inetpub\\wwwroot\\WisePBX\\Uploads\\11-2-4c3dba32-9267-4bf2-9460-3ad82f79f7c5\\Penguins.jpg");
			//wiseSendSocialFile(ticketList[0].ticket_id,"\\\\172.17.7.40\\OnlineCRM_WebChat\\Uploads\\20180704\\20180704102754319_sample.jpg");
			//wiseSendSocialFile(ticketList[0].ticket_id,"20180704102754319_sample.jpg");
			//wiseSendSocialFile(ticketList[0].ticket_id,"C:\\Etrius\\Connector\\uploads\\20180710\\sample1.jpg");
			//wiseSendFax("NP360", "82269218", "D:\\FaxShare\\SCRM TESTING FAX.doc", "Testing Subject", "Testing Message", "Attn Tiger",  "Sender Tiger", "Epro Company");
			//var i=wiseSendFax("5702", "29534898", "D:\\FaxShare\\SCRM TESTING FAX.doc", "D:\\FaxShare\\cover.doc", "Testing Subject", "Testing Message", "Attn Tiger",  "Sender Tiger", "Epro Company");
			//wiseAssignAgent("Inbound_Voicemail", [47458108,47458029],5, function(){alert('assigned');});
			//var i= wiseSendSMS("NP360","92055486","SMS TSTING 1");


			//wiseMakeCall("NP360","27102140");

			//var i=wiseSendSMS_Ex("NP360","92055486","SMS TSTING 2");
			//wiseSendEmail_Ex ("NP360", "tigerpkchong@eprotel.com.hk", "",  "Testing Subject", "Testing email content", "", function(callId){console.log(callId)});
			//wiseSendEmail ("NP360", "tigerpkchong@eprotel.com.hk", "",  "Testing Subject", "Testing email content 2", "");
			//console.log(i);
			//wiseGetTicketMsg("-2083549824");
			//wiseSendSocialMsg_Ex(ticketList[0].ticket_id, "Hello w", null, function(r){console.log(r)});
			//wiseSendSocialFile_Ex(ticketList[0].ticket_id, "D:\\Inetpub\\wwwroot\\WisePBX\\Uploads\\20180720\\-1234567\\Chrysanthemum.jpg", null, function(r){console.log(r)});
			//wiseSendSocialFile(ticketList[0].ticket_id, "D:\\Inetpub\\wwwroot\\WisePBX\\Uploads\\20180720\\-1234567\\Chrysanthemum.jpg");
			//wiseGetTicketMsg(ticketList[0].ticket_id);
			//wsWiseAgent.GetFaceBookPost(loginId,"-324865835");
			//wsWiseAgent.GetSameLevelReply("1598198658",10,1);
			//var r=wiseGetServiceInfo("NP360");
			//console.log(r);
		}
		/*
		addEventListener(document, 'onWiseSocialMsg', function (e) {
			var obj = e.detail;
			console.log(obj);
		});


		addEventListener(document, 'onWiseSocialStatus', function (e) {
			var obj = e.detail;
			console.log(obj);
		});
		*/
	</script>

</head>
<body onload="windowOnload();" style="margin:0px;background:#eeeeee" onkeydown='return (event.keyCode != 116)'>
	<iframe src="mute.mp3" title="mute" hidden allow="autoplay"></iframe>
	<audio id="ringAudio" loop>
		<source src="Ring.mp3" type="audio/mpeg">
	</audio>
	<audio id="queAudio">
		<source src="queue.mp3" type="audio/mpeg">
	</audio>
	<audio id="msgAudio">
		<source src="chattone2.mp3" type="audio/mpeg">
	</audio>
	<div id="softPhone" style="text-align:left;font-size:12px;font-family: Roboto,sans-serif;width:100%">
		<div style="display:none;vertical-align:top;margin:0px;width:200px">

			<input id="panelPhoneNo" type="text" class="num-btn" style="width:170px;height:10px" maxLength="10" />


			<!--<button class="call-btn" style="width:60px;height:40px" onclick="WiseMakeCall();">Call</button>&nbsp;-->
			<!--<button class="call-btn" style="width:60px;height:40px" onclick="WiseDropCall();">Drop</button>&nbsp; -->
			<!--<button id="buttonHold" class="call-btn" style="width:50px;height:40px" onclick="WiseHoldCall();">Hold</button>&nbsp;-->
			<!--
		<button class="call-btn" style="width:50px;height:40px" onclick="WiseMakeConference();" title="Conference">Conf</button>&nbsp;
		<button class="call-btn" style="width:50px;height:40px" onclick="WiseTransferCall();" title="Transfer">Xfer</button>&nbsp;

		-->
			<br />
			<input type="image" src="img/call-out.png" width="30px" class="img-btn" style="vertical-align: middle;" title="Make Call" alt="call-out" onclick="wiseMakeCall();" />
			<input type="image" src="img/call-drop.png" width="30px" style="vertical-align: middle;" title="Drop Call" alt="call-drop" onclick="wiseDropCall();" />
			<input type="image" src="img/call-hold.png" width="30px" style="vertical-align: middle;" title="Hold Call" id="buttonHold" alt="call-hold" onclick="wiseHoldCall();" />
			<input type="image" src="img/call-agent.png" width="30px" style="vertical-align: middle;" title="Call Agent" alt="call-agent" onclick="wiseCallAgent();" />
			<input type="image" src="img/call-conf.png" width="30px" style="vertical-align: middle;" title="Conference Call" alt="call-conf" onclick="wiseMakeConference();" />
			<input type="image" src="img/call-transfer.png" width="30px" style="vertical-align: middle;" title="Transfer Call" alt="call-transfer" onclick="wiseTransferCall();" />
			<br />


			<div class="status-box" style="width:170px;">
				<span id="panelAgentStatus" style="float:left;font-weight: bold;">LOGOUT</span>
				<span id="panelTimeCount" style="float:right;font-weight: bold;">00:00</span>
			</div>
		</div>

		<!--
	<div id="containerP" class="container">
	<hr style="height: 0px; visibility: hidden; margin-Bottom:5px"/>
	<button class="num-btn2">1</button>&nbsp;
	<button class="num-btn2">2</button>&nbsp;
	<button class="num-btn2">3</button>&nbsp;

	<button class="num-btn2">4</button>&nbsp;
	<button class="num-btn2">5</button>&nbsp;
	<button class="num-btn2">6</button>
	<hr style="height: 0px; visibility: hidden; margin-Bottom:-1px"/>
	<button class="num-btn2">7</button>&nbsp;
	<button class="num-btn2">8</button>&nbsp;
	<button class="num-btn2">9</button>&nbsp;
	<button class="num-btn2">0</button>&nbsp;
	<button class="num-btn2">*</button>&nbsp;
	<button class="num-btn2">#</button>
	</div>
	-->
		<div id="container" class="container" style="display:inline-block;width:100%">
			<div style="display:none;">
				<input type="button" onclick="TestGetMsg();" value="test" />
			</div>
			<div id="queueListBar" style="display:inline-block;margin-top:10px;position:relative;vertical-align:top;height:90px;width:100%"></div>

		</div>

		<div id="temp"></div>

				
	</div>
	<script>

			


			var popup = null;
			var originalMsgArr = [];
			//var isKeepMsg= false;
			//var isAcceptCall=false;
			//var canRingtone=true;

			//var isAcceptChat=false;
			//var canChattone=true;
			const popupCenter = function (url, windowName, w, h) {
				const y = window.top.innerHeight / 2 + window.top.screenY - (h / 2);
				const x = window.top.innerWidth / 2 + window.top.screenX - (w / 2);

				// fullscreen=false works on IE only
				return window.open(url, windowName, `toolbar=no, fullscreen=false, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width=${w}, height=${h}, top=${y}, left=${x}`);
			}

			function openAlert(callType, msg, waitCount, waitTime) {
				console.log("originalMsgArr=" + originalMsgArr);
				console.log("callType=" + callType + ", msg=" + msg + ",waitCount=" + waitCount + ",waitTime=" + waitTime);
				/*
				if(isAcceptCall) {
					isAcceptCall=false;
					return;
				}
				*/
				if (userMode == "BREAK") return;

				var idx = originalMsgArr.findIndex(function (el) {
					return el.callType == callType;
				});
				console.log(popup);
				if (popup) {
					if (!popup.closed) {

						//isKeepMsg=true;
						popup.close();
					}
				}
				// var params = [
				//     'height= 500px',
				//     'width=500px',
				// 	'left=1670px',
				// 	'top=300px',
				//     'fullscreen=false' // only works in IE, but here for completeness
				// ].join(',');

				/*
				var r = originalMsgArr.filter(function(el) {
					return el.callType==callType;
				});
				*/
				console.log("idx=" + idx);
				if (idx == -1) {
					if (waitCount == 0) return;
					var msgObj = { "time": new Date(), "callType": callType, "waitCount": waitCount, "waitTime": waitTime, "msg": msg };
					originalMsgArr.push(msgObj);
					// popup = window.open('./alertPopUp.html', 'alert',params);
					popup = popupCenter('./alertPopUp.html', 'alert', 500, 500);
					// popup.onbeforeunload =function(){
					// 	if (!isKeepMsg) originalMsgArr=[];
					// 	isKeepMsg=false;
					// };
			//  } else { // 20250410 'If' statement should not be the only statement in 'else' block
				} else if (waitCount == 0) {
						originalMsgArr.splice(idx, 1);
						console.log("originalMsgArr=" + originalMsgArr);
				} else /*if(originalMsgArr[idx].waitCount != waitCount)*/ {
						originalMsgArr[idx].waitCount = waitCount;
						originalMsgArr[idx].waitTime = waitTime;
					//	} // 20250410 for else if
				}
				if (originalMsgArr.length != 0) {
					// popup = window.open('./alertPopUp.html', 'alert',params);
					popup = popupCenter('./alertPopUp.html', 'alert', 500, 500);
					/*
					popup.onbeforeunload =function(){
						if (!isKeepMsg) originalMsgArr=[];
						isKeepMsg=false;
					};
					*/
				}
				//if(originalMsgArr.length==0) popup.close();
				// popup.opener = window;
				// popup.focus();
				// window.focus();
				// popup.moveTo(0, 0);
				// popup.focus();
			}
			if (config.isWebRTC) { // load the script only when needed
				// var rtcScript1 = document.createElement('script');
				// rtcScript1.setAttribute('src','./script/SIPml-epro.js');
				// document.head.appendChild(rtcScript1);
				// setTimeout(function(){
				// 	var rtcScript2 = document.createElement('script');
				// 	rtcScript2.setAttribute('src','./script/webRTC.js');
				// 	document.head.appendChild(rtcScript2);
				// },500);
				var s = document.createElement("script");
				s.type = "text/javascript";
				s.src = "./script/SIPml-epro.js";
				$("head").append(s)
				var s1 = document.createElement("script");
				s1.type = "text/javascript";
				s1.src = "./script/webRTC.js";
				$("head").append(s1);
			}
	</script>
		<!--------------20241219 for shandler----start---------------------------------------------------------------->
	<script id="wa_template" type="text/x-handlebars-template">

		<div class="wa-qp-tp-container d-inline-block">
			<span style="display: none;" class="wa-template-name">{{TemplateName}}</span>
			<div class="wa-qp-card-container">
				<div id="wa-header" style="{{displayHeader}}">
					{{Header}}

					<div class="wa-card-img-container" style="{{displayHeaderImage}}">
						<i class="fa-image wa-card-img">
							<img src="{{HeaderImageURL}}" style="margin-left: auto; margin-right: auto; max-width: 100%; max-height: 100%;">
						</i>
					</div>
				</div>
				<div class="wa-card-txt" id="wa-message" style="{{displayMessage}}">{{Message}}</div>
				<div id="wa-footer" style="{{displayFooter}}">{{Footer}}</div>
			</div>

			<div class="wa-btn-group" id="wa-btn-group1" style="{{displayBtnGroup1}}">
				<div class="wa-qp-btn" style="background-color:white">{{Button1}}</div>
				<div class="wa-qp-btn" style="background-color:white">{{Button2}}</div>
			</div>
			<div class="wa-btn-group" id="wa-btn-group2" style="{{displayBtnGroup2}}">
				<div class="wa-qp-btn" style="background-color:white">{{Button3}}</div>
			</div>
		
		</div>
	</script>
	<script id="visit_quoted_message_template" type="text/x-handlebars-template">
		<div id="{{messageid}}" class="message-row visitor-row">
			<div>
				<span class="user-icon"><i class="fas fa-user"></i></span>
				<div class="time-with-seconds" title="{{time}}">
					<span></span>
					<span>{{time}}</span>
				</div>
			</div>
			<div class="visitor-content-bubble content-bubble">
				<div class="content-bubble-name">{{SentBy}}</div>

				
					<div class="visitor-content-bubble content-bubble" style="margin-top: 4px; margin-bottom: 6px">
						{{QuotedMsgBody}}
						
					</div>
						{{response}}
				</div>
				
		</div>
	</script>
	<!---20250102 for shandler show message history--start-->
	<script id="chatlist_header_template" type="text/x-handlebars-template">
		<a id="download-link" href="javascript:void(0);" class="btn btn-warning btn-sm text-capitalize rounded mt-3 align-top text-white" onclick="caseHistService.downloadHistoryAsHTML();">
			Download History(HTML file)
		</a>
		<span class="custom-scroll content-basic-info" style="width: calc(100% - 290px); margin-top: 0px;">
			<span class="cs-info-span">
				<span class="content-gray-label">Platform:</span>&nbsp;{{channel}}
			</span>
			<span class="cs-info-span">
				<span class="content-gray-label">Ticket ID:</span>{{ticketId}}
			</span>
			<span id="cs-basic">
				<span>
					<span class="content-gray-label">Name:</span>&nbsp;{{name}}
				</span>
			</span>
			<span id="cs-info">
				<span style="visibility:hidden"><span class="content-gray-label" style="visibility:hidden">Source:</span>&nbsp;{{source}}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
				<!--<span style="visibility:hidden"><span class="content-gray-label" >Language:</span>&nbsp;</span>-->
				<span><span class="content-gray-label">Email:</span>&nbsp;{{email}}</span>
				<span><span class="content-gray-label">Phone:</span>&nbsp;{{phone}}</span>
				<br />
				<span><span id="cs-info-additional" class="content-gray-label">{{additionalInfo}}</span></span>
			</span>
			<!--the image location is different from chatbot -->
			<img id="channel" class="top-channel-img" style="margin-top: -20px; float: right;" data-toggle="tooltip" data-placement="left" src="../../Wise/img/{{channelImg}}">
		</span>
	</script>

	<script id="visitor_message_template" type="text/x-handlebars-template">
		<div id="{{messageid}}" class="message-row visitor-row">
			<div>
				<span class="user-icon"><i class="fas fa-user"></i></span>
				<div class="time-with-seconds" title="{{time}}">
					<span></span>
					<span>{{time}}</span>
				</div>
			</div>
			<div class="visitor-content-bubble content-bubble">
				<div class="content-bubble-name">{{SentBy}}</div>
				<div class="content-bubble-content">
					{{response}}
				</div>
			</div>
		</div>
	</script>
	<script id="agent_message_template" type="text/x-handlebars-template">
		<div id="{{messageid}}" class="message-row agent-row">
			<div class="agent-content-bubble content-bubble">
				<div class="content-bubble-name">{{SentBy}}</div>
				<div class="content-bubble-content">{{messageOutput}}</div>
			</div>
			<div>
				<span class="user-icon"><i class="fas fa-user"></i></span>
				<div class="time-with-seconds" title="{{time}}"><span></span><span>{{time}}</span></div>
			</div>
		</div>
	</script>

	<script id="agent_message_withimage_template" type="text/x-handlebars-template">
		<div id="{{messageid}}" class="message-row agent-row">
			<div class="agent-content-bubble content-bubble">
				<div class="content-bubble-name">{{SentBy}}</div>
				<div class="content-bubble-content" style="white-space: nowrap">
					<div style="text-align:center;">
						<img onclick="enlargeImage(this);" class="content-image" style="{{displayImage}}" alt="{{FileName}}" style="max-width:100%;max-height:200px;" src="{{FileUrl}}">
					</div>
					<div class="position-relative">
						<a href="{{FileUrl}}" target="_blank" download="">{{FileName}}</a>
						<span class="wa-sent-success">sent</span>
					</div>
					<div></div>
				</div>
			</div>
			<div>
				<span class="user-icon"><i class="fas fa-user"></i></span>
				<div class="time-with-seconds" title="{{time}}"><span></span><span>{{time}}</span></div>
			</div>
		</div>
	</script>

	<script id="visitor_message_withimage_template" type="text/x-handlebars-template">
		<div id="{{messageid}}" class="message-row visitor-row">
			<div>
				<span class="user-icon"><i class="fas fa-user"></i></span>
				<div class="time-with-seconds" title="{{time}}">
					<span></span>
					<span>{{time}}</span>
				</div>
			</div>
			<div class="visitor-content-bubble content-bubble">
				<div class="content-bubble-name">{{SentBy}}</div>
				<div class="content-bubble-content" style="white-space: nowrap">
					<div style="text-align:center;">
						<img onclick="enlargeImage(this);" class="content-image" alt="{{FileName}}" style="max-width:100%;max-height:200px;" src="{{FileUrl}}">
					</div>
					<div class="position-relative">
						<a href="{{FileUrl}}" target="_blank" download="">{{FileName}}</a>
					</div>
					<div></div>
				</div>
			</div>
		</div>
	</script>
	<!---20250102 for shandler show message history--end-->



	<script>
		var wa_template = Handlebars.compile($('#wa_template').html());	// located at the end of the page
        var q_template = Handlebars.compile($('#visit_quoted_message_template').html());	// located at the end of the page
							
		var sCompany = "EPRO";
		var sAgentId = loginId;
		var sToken = top.token;
		
		var waTempService = null;
		(async () => {
            waTempService = new WaTemplateService(wa_template, q_template, config.shandlerUrl);
            await waTempService.getTemplateByAPI(sCompany, sAgentId, sToken);
            console.log(waTempService.templateList); // Access the updated template list
		})();
		
		
    //    var waTempService = new WaTemplateService(wa_template, q_template, config.shandlerUrl);
		var caHistService = new CaseHistory();


	

		//waTempService.getTemplateByAPI(sCompany, sAgentId, sToken);

	</script>
	<!---------------20241219 for shandler----End------------------------------------------------------------------------>
</body>
<!-- <script src="./script/SIPml-epro.js" type="text/javascript"> </script>
<script src="./script/webRTC.js" type="text/javascript"> </script> -->
</html>

